<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromeæ‰©å±•è°ƒè¯•å™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #1557b0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            color: #0d7a0d;
            background: #d1ffd1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            color: #f57c00;
            background: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #1976d2;
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log-output {
            background: #1e1e1e;
            color: #ffffff;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 10px 0;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-item {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #1a73e8;
        }
        .copy-btn {
            background: #28a745;
            float: right;
            margin-top: -5px;
        }
        .copy-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Chromeæ‰©å±•è°ƒè¯•å™¨</h1>
        
        <div class="section">
            <h3>ğŸ“Š ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥</h3>
            <button onclick="checkSystemInfo()">æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯</button>
            <div id="system-info"></div>
        </div>

        <div class="section">
            <h3>ğŸ”Œ Chrome API æ£€æŸ¥</h3>
            <button onclick="checkChromeAPIs()">æ£€æŸ¥Chrome APIs</button>
            <div id="api-info"></div>
        </div>

        <div class="section">
            <h3>ğŸ“¦ æ‰©å±•çŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkExtensionStatus()">æ£€æŸ¥æ‰©å±•çŠ¶æ€</button>
            <button onclick="testExtensionConnection()">æµ‹è¯•æ‰©å±•è¿æ¥</button>
            <div id="extension-info"></div>
        </div>

        <div class="section">
            <h3>ğŸ¯ ä¾§è¾¹æ åŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testSidePanelAPI()">æµ‹è¯•ä¾§è¾¹æ API</button>
            <button onclick="trySidePanelOpen()">å°è¯•æ‰“å¼€ä¾§è¾¹æ </button>
            <div id="sidepanel-info"></div>
        </div>

        <div class="section">
            <h3>ğŸ“‹ å®Œæ•´è¯Šæ–­æŠ¥å‘Š</h3>
            <button onclick="generateFullReport()">ç”Ÿæˆå®Œæ•´æŠ¥å‘Š</button>
            <button onclick="copyReport()" class="copy-btn">å¤åˆ¶æŠ¥å‘Š</button>
            <div id="full-report"></div>
        </div>

        <div class="section">
            <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <div id="log" class="log-output">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        let logElement;
        let fullReportData = {};

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(logEntry);
            
            if (!logElement) {
                logElement = document.getElementById('log');
            }
            
            logElement.textContent += logEntry + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            if (logElement) {
                logElement.textContent = '';
            }
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${content}</div>`;
        }

        function checkSystemInfo() {
            log('å¼€å§‹æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯...');
            
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                chromeVersion: navigator.userAgent.match(/Chrome\/([0-9.]+)/)?.[1] || 'æœªçŸ¥',
                url: window.location.href,
                timestamp: new Date().toISOString()
            };

            fullReportData.systemInfo = info;

            const content = `
                <strong>æµè§ˆå™¨ä¿¡æ¯:</strong><br>
                â€¢ Chromeç‰ˆæœ¬: ${info.chromeVersion}<br>
                â€¢ å¹³å°: ${info.platform}<br>
                â€¢ è¯­è¨€: ${info.language}<br>
                â€¢ åœ¨çº¿çŠ¶æ€: ${info.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}<br>
                â€¢ Cookieå¯ç”¨: ${info.cookieEnabled ? 'æ˜¯' : 'å¦'}<br>
                â€¢ User Agent: ${info.userAgent}
            `;

            showResult('system-info', content, 'success');
            log('ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥å®Œæˆ');
        }

        function checkChromeAPIs() {
            log('å¼€å§‹æ£€æŸ¥Chrome APIs...');
            
            const apis = {
                chrome: !!window.chrome,
                chromeRuntime: !!window.chrome?.runtime,
                chromeStorage: !!window.chrome?.storage,
                chromeTabs: !!window.chrome?.tabs,
                chromeAction: !!window.chrome?.action,
                chromeSidePanel: !!window.chrome?.sidePanel,
                chromeScripting: !!window.chrome?.scripting
            };

            fullReportData.chromeAPIs = apis;

            let content = '<strong>Chrome API å¯ç”¨æ€§:</strong><br>';
            for (const [api, available] of Object.entries(apis)) {
                const status = available ? 'âœ…' : 'âŒ';
                const color = available ? 'green' : 'red';
                content += `â€¢ ${api}: <span style="color: ${color}">${status}</span><br>`;
            }

            // æ£€æŸ¥å…·ä½“çš„Chromeå¯¹è±¡å±æ€§
            if (window.chrome) {
                const chromeProps = Object.getOwnPropertyNames(window.chrome);
                content += `<br><strong>å¯ç”¨çš„Chromeå±æ€§:</strong><br>${chromeProps.join(', ')}`;
                fullReportData.chromeProperties = chromeProps;
            }

            const type = apis.chrome ? 'success' : 'error';
            showResult('api-info', content, type);
            log('Chrome APIsæ£€æŸ¥å®Œæˆ');
        }

        function checkExtensionStatus() {
            log('å¼€å§‹æ£€æŸ¥æ‰©å±•çŠ¶æ€...');
            
            if (!window.chrome?.runtime) {
                showResult('extension-info', 'âŒ Chromeæ‰©å±•APIä¸å¯ç”¨', 'error');
                log('Chromeæ‰©å±•APIä¸å¯ç”¨');
                return;
            }

            try {
                const extensionId = chrome.runtime.id;
                const manifest = chrome.runtime.getManifest ? chrome.runtime.getManifest() : null;
                
                const info = {
                    extensionId: extensionId,
                    manifest: manifest,
                    lastError: chrome.runtime.lastError?.message || 'æ— '
                };

                fullReportData.extensionInfo = info;

                let content = `
                    <strong>æ‰©å±•ä¿¡æ¯:</strong><br>
                    â€¢ æ‰©å±•ID: ${extensionId || 'æœªçŸ¥'}<br>
                    â€¢ æœ€åé”™è¯¯: ${info.lastError}<br>
                `;

                if (manifest) {
                    content += `
                        â€¢ æ‰©å±•åç§°: ${manifest.name}<br>
                        â€¢ ç‰ˆæœ¬: ${manifest.version}<br>
                        â€¢ Manifestç‰ˆæœ¬: ${manifest.manifest_version}<br>
                        â€¢ æƒé™: ${manifest.permissions?.join(', ') || 'æ— '}<br>
                    `;
                }

                showResult('extension-info', content, 'success');
                log('æ‰©å±•çŠ¶æ€æ£€æŸ¥å®Œæˆ');
            } catch (error) {
                const errorMsg = `æ‰©å±•çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`;
                showResult('extension-info', `âŒ ${errorMsg}`, 'error');
                log(errorMsg);
                fullReportData.extensionError = error.message;
            }
        }

        function testExtensionConnection() {
            log('æµ‹è¯•æ‰©å±•è¿æ¥...');
            
            if (!window.chrome?.runtime) {
                showResult('extension-info', 'âŒ Chromeæ‰©å±•APIä¸å¯ç”¨ï¼Œæ— æ³•æµ‹è¯•è¿æ¥', 'error');
                return;
            }

            try {
                chrome.runtime.sendMessage({ 
                    type: 'debug_test',
                    timestamp: Date.now()
                }, (response) => {
                    if (chrome.runtime.lastError) {
                        const error = chrome.runtime.lastError.message;
                        showResult('extension-info', `âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error}`, 'error');
                        log(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error}`);
                        fullReportData.connectionError = error;
                    } else {
                        showResult('extension-info', `âœ… è¿æ¥æµ‹è¯•æˆåŠŸ: ${JSON.stringify(response)}`, 'success');
                        log('è¿æ¥æµ‹è¯•æˆåŠŸ');
                        fullReportData.connectionSuccess = response;
                    }
                });
            } catch (error) {
                const errorMsg = `è¿æ¥æµ‹è¯•å¼‚å¸¸: ${error.message}`;
                showResult('extension-info', `âŒ ${errorMsg}`, 'error');
                log(errorMsg);
                fullReportData.connectionException = error.message;
            }
        }

        function testSidePanelAPI() {
            log('æµ‹è¯•ä¾§è¾¹æ API...');
            
            const sidePanelAPI = {
                available: !!window.chrome?.sidePanel,
                methods: []
            };

            if (window.chrome?.sidePanel) {
                sidePanelAPI.methods = Object.getOwnPropertyNames(window.chrome.sidePanel);
                
                const content = `
                    âœ… <strong>ä¾§è¾¹æ APIå¯ç”¨</strong><br>
                    â€¢ å¯ç”¨æ–¹æ³•: ${sidePanelAPI.methods.join(', ')}<br>
                    â€¢ APIå¯¹è±¡: ${typeof window.chrome.sidePanel}
                `;
                showResult('sidepanel-info', content, 'success');
                log('ä¾§è¾¹æ APIæ£€æŸ¥é€šè¿‡');
            } else {
                const content = `
                    âŒ <strong>ä¾§è¾¹æ APIä¸å¯ç”¨</strong><br>
                    è¿™å¯èƒ½æ˜¯å› ä¸º:<br>
                    â€¢ Chromeç‰ˆæœ¬è¿‡ä½ (éœ€è¦114+)<br>
                    â€¢ æ‰©å±•æœªæ­£ç¡®åŠ è½½<br>
                    â€¢ æƒé™é…ç½®é—®é¢˜
                `;
                showResult('sidepanel-info', content, 'error');
                log('ä¾§è¾¹æ APIä¸å¯ç”¨');
            }

            fullReportData.sidePanelAPI = sidePanelAPI;
        }

        function trySidePanelOpen() {
            log('å°è¯•æ‰“å¼€ä¾§è¾¹æ ...');
            
            if (!window.chrome?.sidePanel) {
                showResult('sidepanel-info', 'âŒ ä¾§è¾¹æ APIä¸å¯ç”¨', 'error');
                return;
            }

            // æ³¨æ„ï¼šåœ¨ç½‘é¡µä¸­æ— æ³•ç›´æ¥è°ƒç”¨chrome.sidePanel.open()
            // è¿™éœ€è¦åœ¨æ‰©å±•çš„èƒŒæ™¯è„šæœ¬ä¸­æ‰§è¡Œ
            showResult('sidepanel-info', `
                âš ï¸ <strong>æ— æ³•ä»ç½‘é¡µç›´æ¥æ‰“å¼€ä¾§è¾¹æ </strong><br>
                ä¾§è¾¹æ åªèƒ½é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰“å¼€:<br>
                â€¢ ç‚¹å‡»æ‰©å±•å›¾æ ‡<br>
                â€¢ ä½¿ç”¨keyboardå¿«æ·é”®<br>
                â€¢ åœ¨èƒŒæ™¯è„šæœ¬ä¸­è°ƒç”¨API<br><br>
                è¯·å°è¯•ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ ä¸­çš„æ‰©å±•å›¾æ ‡
            `, 'warning');
            log('ä¾§è¾¹æ æ‰“å¼€è¯´æ˜å·²æ˜¾ç¤º');
        }

        function generateFullReport() {
            log('ç”Ÿæˆå®Œæ•´è¯Šæ–­æŠ¥å‘Š...');
            
            // æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
            checkSystemInfo();
            setTimeout(() => {
                checkChromeAPIs();
                setTimeout(() => {
                    checkExtensionStatus();
                    setTimeout(() => {
                        testSidePanelAPI();
                        setTimeout(() => {
                            displayFullReport();
                        }, 500);
                    }, 500);
                }, 500);
            }, 500);
        }

        function displayFullReport() {
            const report = JSON.stringify(fullReportData, null, 2);
            const reportElement = document.getElementById('full-report');
            
            reportElement.innerHTML = `
                <div class="info">
                    <strong>è¯Šæ–­æŠ¥å‘Šå·²ç”Ÿæˆ</strong><br>
                    æŠ¥å‘Šæ—¶é—´: ${new Date().toLocaleString()}<br>
                    æ•°æ®å®Œæ•´æ€§: ${Object.keys(fullReportData).length} é¡¹æ£€æŸ¥å®Œæˆ
                </div>
                <div class="log-output">${report}</div>
            `;
            
            log('å®Œæ•´è¯Šæ–­æŠ¥å‘Šç”Ÿæˆå®Œæˆ');
        }

        function copyReport() {
            const reportText = JSON.stringify(fullReportData, null, 2);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(reportText).then(() => {
                    log('æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    alert('è¯Šæ–­æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(err => {
                    log(`å¤åˆ¶å¤±è´¥: ${err.message}`);
                    fallbackCopy(reportText);
                });
            } else {
                fallbackCopy(reportText);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                log('æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (fallback)');
                alert('è¯Šæ–­æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            } catch (err) {
                log(`å¤åˆ¶å¤±è´¥: ${err.message}`);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æŠ¥å‘Šå†…å®¹');
            }
            document.body.removeChild(textArea);
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            logElement = document.getElementById('log');
            log('Chromeæ‰©å±•è°ƒè¯•å™¨å·²åŠ è½½');
            log('è¯·ç‚¹å‡»ç›¸åº”æŒ‰é’®å¼€å§‹æ£€æŸ¥...');
        });
    </script>
</body>
</html>