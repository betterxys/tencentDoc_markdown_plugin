<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•ä¿®å¤åçš„è¡¨æ ¼æ£€æµ‹</title>
    <script src="lib/marked.min.js"></script>
    <script src="lib/purify.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        
        .test-section {
            margin: 20px 0;
            border: 2px solid #007bff;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .result {
            border: 1px solid #28a745;
            padding: 16px;
            margin: 16px 0;
            border-radius: 6px;
            background-color: white;
        }
        
        .debug-log {
            background: #343a40;
            color: #28a745;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        table {
            border-collapse: collapse !important;
            width: 100% !important;
            margin: 16px 0 !important;
            border: 2px solid #007bff !important;
        }
        
        th, td {
            padding: 12px !important;
            text-align: left !important;
            border: 1px solid #007bff !important;
        }
        
        th {
            background-color: #e3f2fd !important;
            font-weight: 600 !important;
            color: #1976d2 !important;
        }
        
        tr:nth-child(even) td {
            background-color: #f8f9fa !important;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æµ‹è¯•ä¿®å¤åçš„è¡¨æ ¼æ£€æµ‹</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ ç”¨æˆ·å¤±è´¥å†…å®¹æµ‹è¯•</h2>
        <button onclick="testFailingContent()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸš€ æµ‹è¯•å¤±è´¥å†…å®¹</button>
        <div id="result-failing" class="result"></div>
        <details>
            <summary>ğŸ“Š æŸ¥çœ‹è°ƒè¯•æ—¥å¿—</summary>
            <div id="debug-failing" class="debug-log"></div>
        </details>
    </div>
    
    <div class="test-section">
        <h2>ğŸ§ª å¯¹æ¯”æµ‹è¯•</h2>
        <button onclick="runComparisonTests()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ” è¿è¡Œå¯¹æ¯”æµ‹è¯•</button>
        <div id="result-comparison" class="result"></div>
        <details>
            <summary>ğŸ“ˆ æŸ¥çœ‹å¯¹æ¯”æ—¥å¿—</summary>
            <div id="debug-comparison" class="debug-log"></div>
        </details>
    </div>
    
    <script>
        function log(sectionId, message, level = 'info') {
            const debugDiv = document.getElementById(`debug-${sectionId}`);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = level === 'success' ? 'âœ…' : level === 'warning' ? 'âš ï¸' : level === 'error' ? 'âŒ' : 'â„¹ï¸';
            debugDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        function clearLog(sectionId) {
            document.getElementById(`debug-${sectionId}`).textContent = '';
        }
        
        // ä½¿ç”¨ä¿®å¤åçš„è¡¨æ ¼æ£€æµ‹é€»è¾‘ï¼ˆä¸sidepanel.jsä¿æŒä¸€è‡´ï¼‰
        function detectTableFixed(content) {
            const hasTableNew = /\|.*\|[\s\S]*?\n\s*\|(\s*[\-:]+\s*\|)+\s*/.test(content);
            const hasTableOld = /\|.*\|/.test(content);
            
            return {
                newDetection: hasTableNew,
                oldDetection: hasTableOld,
                allPipes: content.match(/\|[^|\n]*\|/g),
                tables: content.match(/\|.*\|[\s\S]*?\n\s*\|(\s*[\-:]+\s*\|)+\s*[\s\S]*?(?=\n\s*\n|\n\s*[^|]|\n\s*$|$)/g)
            };
        }
        
        // æ—§çš„è¡¨æ ¼æ£€æµ‹é€»è¾‘ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
        function detectTableOld(content) {
            const hasTableOld = /\|.*\|[\s\S]*?\n\s*\|[\s\-:]*\|/.test(content);
            return {
                detection: hasTableOld,
                tables: content.match(/\|.*\|[\s\S]*?\n\s*\|[\s\-:]*\|[\s\S]*?(?=\n\s*\n|\n\s*[^|]|\n\s*$|$)/g)
            };
        }
        
        function renderWithDetection(content, sectionId, useNewDetection = true) {
            const detection = useNewDetection ? detectTableFixed(content) : detectTableOld(content);
            const hasTable = useNewDetection ? detection.newDetection : detection.detection;
            
            log(sectionId, `å¼€å§‹æ¸²æŸ“æµ‹è¯• (${useNewDetection ? 'æ–°' : 'æ—§'}æ£€æµ‹é€»è¾‘)`);
            log(sectionId, `å†…å®¹é•¿åº¦: ${content.length}`);
            log(sectionId, `æ£€æµ‹åˆ°è¡¨æ ¼: ${hasTable}`, hasTable ? 'success' : 'warning');
            
            if (detection.allPipes) {
                log(sectionId, `æ‰¾åˆ° ${detection.allPipes.length} ä¸ªç«–çº¿æ¨¡å¼`);
            }
            
            if (detection.tables) {
                log(sectionId, `æ‰¾åˆ° ${detection.tables.length} ä¸ªçœŸå®è¡¨æ ¼`, 'success');
                detection.tables.forEach((table, i) => {
                    log(sectionId, `è¡¨æ ¼ ${i+1} é¢„è§ˆ: ${table.substring(0, 50)}...`);
                });
            } else {
                log(sectionId, `æ²¡æœ‰æ‰¾åˆ°çœŸå®è¡¨æ ¼`, 'error');
            }
            
            try {
                let html;
                if (typeof marked.parse === 'function') {
                    html = marked.parse(content, { gfm: true, breaks: false });
                    log(sectionId, 'ä½¿ç”¨ marked.parse() æˆåŠŸ', 'success');
                } else {
                    html = marked(content, { gfm: true, breaks: false });
                    log(sectionId, 'ä½¿ç”¨ marked() æˆåŠŸ', 'success');
                }
                
                log(sectionId, `ç”ŸæˆHTMLé•¿åº¦: ${html.length}`);
                log(sectionId, `åŒ…å«<table>æ ‡ç­¾: ${/<table/.test(html)}`, /<table/.test(html) ? 'success' : 'error');
                
                const cleanHtml = DOMPurify.sanitize(html, {
                    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'div', 'span', 'strong', 'em', 'u', 'code', 'pre', 'ul', 'ol', 'li', 'blockquote', 'a', 'img', 'br', 'hr', 'table', 'thead', 'tbody', 'tr', 'th', 'td'],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'align', 'style', 'colspan', 'rowspan']
                });
                
                log(sectionId, `DOMPurifyæ¸…ç†åé•¿åº¦: ${cleanHtml.length}`);
                log(sectionId, `æœ€ç»ˆåŒ…å«<table>æ ‡ç­¾: ${/<table/.test(cleanHtml)}`, /<table/.test(cleanHtml) ? 'success' : 'error');
                
                return cleanHtml;
                
            } catch (error) {
                log(sectionId, `æ¸²æŸ“é”™è¯¯: ${error.message}`, 'error');
                return `<div style="color: red; font-weight: bold;">æ¸²æŸ“å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function testFailingContent() {
            const failingContent = \`æ€è€ƒè¿‡ç¨‹ï¼š

å—¯ï¼Œç”¨æˆ·è¯¢é—®ç½‘å®‰é™©ä¸å¤©åˆ›æœºå™¨äººäº§å“æ†ç»‘é”€å”®åœ¨åŒ–å·¥åŠç”µåŠ›è¡Œä¸šçš„è®¾è®¡æ–¹æ¡ˆã€‚

### âš™ï¸ **ä¸€ã€è¡Œä¸šé£é™©ç‰¹æ€§ä¸ä¿é™©éœ€æ±‚**

| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** | **ç½‘å®‰é™©ä¿éšœé‡ç‚¹** | **æ”¿ç­–ä¾æ®** |
|----------|------------------|-------------------|-------------|
| **åŒ–å·¥è¡Œä¸š** | å·¥æ§ç³»ç»Ÿï¼ˆDCS/SISï¼‰é­å‹’ç´¢æ”»å‡»å¯¼è‡´ç”Ÿäº§ä¸­æ–­ | è¦†ç›–åœäº§æŸå¤±ï¼ˆæ—¥å‡äº§å€¼Ã—åœæœºå¤©æ•°ï¼‰ | ã€Šå·¥ä¸šæ§åˆ¶ç³»ç»Ÿä¿¡æ¯å®‰å…¨é˜²æŠ¤æŒ‡å—ã€‹ |
| **ç”µåŠ›è¡Œä¸š** | ç”µç½‘ç›‘æ§ç³»ç»Ÿè¢«å…¥ä¾µå¼•å‘å¤§é¢ç§¯åœç”µ | èµ”å¿ç”µç½‘ç˜«ç—ªç½šæ¬¾ï¼ˆå•æ¬¡æœ€é«˜500ä¸‡ï¼‰ | ã€Šç”µåŠ›å¯é æ€§ç®¡ç†åŠæ³•ã€‹ |

è¿™æ˜¯ä¿é™©+ç§‘æŠ€+æœåŠ¡çš„æ¨¡å¼ã€‚\`;
            
            clearLog('failing');
            log('failing', 'ğŸš€ å¼€å§‹æµ‹è¯•ç”¨æˆ·å¤±è´¥å†…å®¹');
            
            const result = renderWithDetection(failingContent, 'failing', true);
            document.getElementById('result-failing').innerHTML = result;
            
            // æ£€æŸ¥æœ€ç»ˆæ¸²æŸ“ç»“æœ
            const tables = document.getElementById('result-failing').querySelectorAll('table');
            if (tables.length > 0) {
                log('failing', \`ğŸ‰ æˆåŠŸï¼æ¸²æŸ“äº† \${tables.length} ä¸ªè¡¨æ ¼\`, 'success');
                tables.forEach((table, i) => {
                    const rows = table.querySelectorAll('tr');
                    const headers = table.querySelectorAll('th');
                    const cells = table.querySelectorAll('td');
                    log('failing', \`è¡¨æ ¼\${i+1}: \${rows.length}è¡Œ, \${headers.length}ä¸ªè¡¨å¤´, \${cells.length}ä¸ªå•å…ƒæ ¼\`, 'success');
                });
            } else {
                log('failing', 'âŒ å¤±è´¥ï¼æ²¡æœ‰æ¸²æŸ“å‡ºè¡¨æ ¼', 'error');
            }
        }
        
        function runComparisonTests() {
            clearLog('comparison');
            log('comparison', 'ğŸ” å¼€å§‹å¯¹æ¯”æµ‹è¯•');
            
            const testContent = \`| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** | **ç½‘å®‰é™©ä¿éšœé‡ç‚¹** | **æ”¿ç­–ä¾æ®** |
|----------|------------------|-------------------|-------------|
| **åŒ–å·¥è¡Œä¸š** | å·¥æ§ç³»ç»Ÿï¼ˆDCS/SISï¼‰é­å‹’ç´¢æ”»å‡»å¯¼è‡´ç”Ÿäº§ä¸­æ–­ | è¦†ç›–åœäº§æŸå¤±ï¼ˆæ—¥å‡äº§å€¼Ã—åœæœºå¤©æ•°ï¼‰ | ã€Šå·¥ä¸šæ§åˆ¶ç³»ç»Ÿä¿¡æ¯å®‰å…¨é˜²æŠ¤æŒ‡å—ã€‹ |
| **ç”µåŠ›è¡Œä¸š** | ç”µç½‘ç›‘æ§ç³»ç»Ÿè¢«å…¥ä¾µå¼•å‘å¤§é¢ç§¯åœç”µ | èµ”å¿ç”µç½‘ç˜«ç—ªç½šæ¬¾ï¼ˆå•æ¬¡æœ€é«˜500ä¸‡ï¼‰ | ã€Šç”µåŠ›å¯é æ€§ç®¡ç†åŠæ³•ã€‹ |\`;
            
            log('comparison', 'æµ‹è¯•å†…å®¹: çº¯è¡¨æ ¼å†…å®¹');
            
            // æµ‹è¯•æ—§æ£€æµ‹é€»è¾‘
            log('comparison', '\\n=== æ—§æ£€æµ‹é€»è¾‘æµ‹è¯• ===');
            const oldDetection = detectTableOld(testContent);
            log('comparison', \`æ—§æ£€æµ‹ç»“æœ: \${oldDetection.detection}\`, oldDetection.detection ? 'success' : 'error');
            
            // æµ‹è¯•æ–°æ£€æµ‹é€»è¾‘
            log('comparison', '\\n=== æ–°æ£€æµ‹é€»è¾‘æµ‹è¯• ===');
            const newDetection = detectTableFixed(testContent);
            log('comparison', \`æ–°æ£€æµ‹ç»“æœ: \${newDetection.newDetection}\`, newDetection.newDetection ? 'success' : 'error');
            
            // æ¸²æŸ“æµ‹è¯•
            log('comparison', '\\n=== æ¸²æŸ“æµ‹è¯• ===');
            const result = renderWithDetection(testContent, 'comparison', true);
            
            document.getElementById('result-comparison').innerHTML = \`
                <h3>ğŸ“Š æ£€æµ‹å¯¹æ¯”ç»“æœ</h3>
                <p><strong>æ—§æ£€æµ‹é€»è¾‘:</strong> <span class="\${oldDetection.detection ? 'success' : 'error'}">\${oldDetection.detection ? 'âœ… æ£€æµ‹åˆ°è¡¨æ ¼' : 'âŒ æœªæ£€æµ‹åˆ°è¡¨æ ¼'}</span></p>
                <p><strong>æ–°æ£€æµ‹é€»è¾‘:</strong> <span class="\${newDetection.newDetection ? 'success' : 'error'}">\${newDetection.newDetection ? 'âœ… æ£€æµ‹åˆ°è¡¨æ ¼' : 'âŒ æœªæ£€æµ‹åˆ°è¡¨æ ¼'}</span></p>
                <h3>ğŸ¨ æ¸²æŸ“ç»“æœ</h3>
                \${result}
            \`;
            
            log('comparison', 'âœ… å¯¹æ¯”æµ‹è¯•å®Œæˆ', 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        window.onload = function() {
            console.log('ğŸ”§ è¡¨æ ¼æ£€æµ‹ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('marked.jsç‰ˆæœ¬:', marked.version || 'unknown');
            console.log('DOMPurifyå¯ç”¨:', typeof DOMPurify === 'object');
        };
    </script>
</body>
</html>