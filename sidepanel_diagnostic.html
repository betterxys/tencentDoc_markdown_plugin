<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¾§è¾¹æ è¯Šæ–­é¡µé¢</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .diagnostic-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #1a73e8;
      text-align: center;
      margin-bottom: 30px;
    }
    .status-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
    }
    .status-section h3 {
      margin-top: 0;
      color: #333;
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      padding: 8px;
      background: white;
      border-radius: 4px;
    }
    .status-ok {
      color: #0d7a0d;
      background: #d1ffd1;
    }
    .status-error {
      color: #d32f2f;
      background: #ffebee;
    }
    .status-warning {
      color: #f57c00;
      background: #fff3e0;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #1557b0;
    }
    .log-output {
      background: #1e1e1e;
      color: #ffffff;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin: 10px 0;
    }
    .test-area {
      margin: 20px 0;
      padding: 15px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <div class="diagnostic-container">
    <h1>ğŸ”§ ä¾§è¾¹æ è¯Šæ–­å·¥å…·</h1>
    
    <div class="status-section">
      <h3>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
      <div id="basic-info"></div>
    </div>
    
    <div class="status-section">
      <h3>ğŸ“š ä¾èµ–åº“çŠ¶æ€</h3>
      <div id="library-status"></div>
    </div>
    
    <div class="status-section">
      <h3>ğŸ”Œ Chrome API çŠ¶æ€</h3>
      <div id="api-status"></div>
    </div>
    
    <div class="status-section">
      <h3>ğŸ“ DOM å…ƒç´ çŠ¶æ€</h3>
      <div id="dom-status"></div>
    </div>
    
    <div class="status-section">
      <h3>ğŸ› ï¸ æ“ä½œé¢æ¿</h3>
      <button onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
      <button onclick="testMarkdownRendering()">æµ‹è¯•Markdownæ¸²æŸ“</button>
      <button onclick="testMessagePassing()">æµ‹è¯•æ¶ˆæ¯ä¼ é€’</button>
      <button onclick="clearDiagnosticLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>
    
    <div class="test-area">
      <h3>ğŸ¯ æµ‹è¯•ç»“æœ</h3>
      <div id="test-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="status-section">
      <h3>ğŸ“„ è¯Šæ–­æ—¥å¿—</h3>
      <div id="diagnostic-log" class="log-output">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…è¯Šæ–­...</div>
    </div>
  </div>

  <!-- åŠ è½½å¿…è¦çš„ä¾èµ–åº“ -->
  <script src="lib/markdown-it.min.js"></script>
  <script src="lib/purify.min.js"></script>
  <script src="lib/mermaid.min.js"></script>

  <script>
    let diagnosticLog = '';
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      diagnosticLog += logEntry + '\n';
      console.log(logEntry);
      
      const logElement = document.getElementById('diagnostic-log');
      if (logElement) {
        logElement.textContent = diagnosticLog;
        logElement.scrollTop = logElement.scrollHeight;
      }
    }
    
    function clearDiagnosticLog() {
      diagnosticLog = '';
      document.getElementById('diagnostic-log').textContent = 'æ—¥å¿—å·²æ¸…é™¤...';
    }
    
    function updateStatus(elementId, items) {
      const element = document.getElementById(elementId);
      element.innerHTML = '';
      
      Object.entries(items).forEach(([name, status]) => {
        const item = document.createElement('div');
        item.className = 'status-item';
        
        let statusClass = 'status-error';
        let statusIcon = 'âŒ';
        
        if (status === true) {
          statusClass = 'status-ok';
          statusIcon = 'âœ…';
        } else if (status === 'warning') {
          statusClass = 'status-warning';
          statusIcon = 'âš ï¸';
        }
        
        item.className += ' ' + statusClass;
        item.innerHTML = `
          <span>${name}</span>
          <span>${statusIcon}</span>
        `;
        
        element.appendChild(item);
      });
    }
    
    function runFullDiagnostic() {
      log('å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­...');
      
      // åŸºæœ¬ä¿¡æ¯æ£€æŸ¥
      const basicInfo = {
        'é¡µé¢URL': location.href.includes('chrome-extension://'),
        'æ–‡æ¡£çŠ¶æ€': document.readyState === 'complete',
        'Chromeç‰ˆæœ¬': navigator.userAgent.includes('Chrome'),
        'æ‰©å±•ç¯å¢ƒ': !!window.chrome?.runtime
      };
      updateStatus('basic-info', basicInfo);
      log(`åŸºæœ¬ä¿¡æ¯æ£€æŸ¥å®Œæˆ: ${Object.values(basicInfo).filter(v => v).length}/${Object.keys(basicInfo).length} é¡¹é€šè¿‡`);
      
      // ä¾èµ–åº“æ£€æŸ¥
      const libraryStatus = {
        'markdown-it': typeof markdownit !== 'undefined',
        'DOMPurify': typeof DOMPurify !== 'undefined',
        'Mermaid': typeof mermaid !== 'undefined'
      };
      updateStatus('library-status', libraryStatus);
      log(`ä¾èµ–åº“æ£€æŸ¥å®Œæˆ: ${Object.values(libraryStatus).filter(v => v).length}/${Object.keys(libraryStatus).length} ä¸ªåº“åŠ è½½æˆåŠŸ`);
      
      // Chrome APIæ£€æŸ¥
      const apiStatus = {
        'chrome': !!window.chrome,
        'chrome.runtime': !!window.chrome?.runtime,
        'chrome.storage': !!window.chrome?.storage,
        'chrome.sidePanel': !!window.chrome?.sidePanel
      };
      updateStatus('api-status', apiStatus);
      log(`Chrome APIæ£€æŸ¥å®Œæˆ: ${Object.values(apiStatus).filter(v => v).length}/${Object.keys(apiStatus).length} ä¸ªAPIå¯ç”¨`);
      
      // DOMå…ƒç´ æ£€æŸ¥ï¼ˆæ¨¡æ‹Ÿä¾§è¾¹æ åº”æœ‰çš„å…ƒç´ ï¼‰
      const requiredElements = [
        'markdown-output', 'timestamp', 'content-info', 
        'log-messages', 'debug-console', 'refresh-btn'
      ];
      
      const domStatus = {};
      requiredElements.forEach(id => {
        domStatus[id] = !!document.getElementById(id);
      });
      updateStatus('dom-status', domStatus);
      log(`DOMå…ƒç´ æ£€æŸ¥å®Œæˆ: ${Object.values(domStatus).filter(v => v).length}/${Object.keys(domStatus).length} ä¸ªå…ƒç´ å­˜åœ¨`);
      
      // æ€»ç»“
      const totalItems = Object.keys(basicInfo).length + Object.keys(libraryStatus).length + 
                        Object.keys(apiStatus).length + Object.keys(domStatus).length;
      const passedItems = Object.values(basicInfo).filter(v => v).length +
                         Object.values(libraryStatus).filter(v => v).length +
                         Object.values(apiStatus).filter(v => v).length +
                         Object.values(domStatus).filter(v => v).length;
      
      log(`è¯Šæ–­å®Œæˆ: ${passedItems}/${totalItems} é¡¹æ£€æŸ¥é€šè¿‡`);
      
      if (passedItems === totalItems) {
        log('âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œä¾§è¾¹æ åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œ');
      } else {
        log(`âš ï¸ å‘ç° ${totalItems - passedItems} ä¸ªé—®é¢˜ï¼Œå¯èƒ½å½±å“ä¾§è¾¹æ åŠŸèƒ½`);
      }
    }
    
    function testMarkdownRendering() {
      log('å¼€å§‹æµ‹è¯•Markdownæ¸²æŸ“...');
      
      if (typeof markdownit === 'undefined') {
        log('âŒ markdown-itæœªåŠ è½½ï¼Œæ— æ³•æµ‹è¯•æ¸²æŸ“');
        document.getElementById('test-result').innerHTML = '<div style="color: red;">markdown-itæœªåŠ è½½</div>';
        return;
      }
      
      try {
        const md = markdownit();
        const testContent = `# æµ‹è¯•æ ‡é¢˜

è¿™æ˜¯ä¸€ä¸ª**ç²—ä½“**å’Œ*æ–œä½“*çš„æµ‹è¯•ã€‚

| åˆ—1 | åˆ—2 |
|-----|-----|
| æ•°æ®1 | æ•°æ®2 |

- åˆ—è¡¨é¡¹1
- åˆ—è¡¨é¡¹2

\`\`\`javascript
console.log('ä»£ç å—æµ‹è¯•');
\`\`\``;
        
        const html = md.render(testContent);
        document.getElementById('test-result').innerHTML = html;
        log('âœ… Markdownæ¸²æŸ“æµ‹è¯•æˆåŠŸ');
      } catch (error) {
        log(`âŒ Markdownæ¸²æŸ“æµ‹è¯•å¤±è´¥: ${error.message}`);
        document.getElementById('test-result').innerHTML = `<div style="color: red;">æ¸²æŸ“å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    function testMessagePassing() {
      log('å¼€å§‹æµ‹è¯•æ¶ˆæ¯ä¼ é€’...');
      
      if (!window.chrome?.runtime) {
        log('âŒ Chrome runtime APIä¸å¯ç”¨ï¼Œæ— æ³•æµ‹è¯•æ¶ˆæ¯ä¼ é€’');
        return;
      }
      
      try {
        chrome.runtime.sendMessage({
          type: 'debug_test',
          timestamp: Date.now(),
          source: 'diagnostic_page'
        }, response => {
          if (chrome.runtime.lastError) {
            log(`âŒ æ¶ˆæ¯ä¼ é€’æµ‹è¯•å¤±è´¥: ${chrome.runtime.lastError.message}`);
          } else {
            log(`âœ… æ¶ˆæ¯ä¼ é€’æµ‹è¯•æˆåŠŸ: ${JSON.stringify(response)}`);
          }
        });
      } catch (error) {
        log(`âŒ æ¶ˆæ¯ä¼ é€’æµ‹è¯•å¼‚å¸¸: ${error.message}`);
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œè¯Šæ–­
    document.addEventListener('DOMContentLoaded', () => {
      log('è¯Šæ–­é¡µé¢åŠ è½½å®Œæˆ');
      setTimeout(runFullDiagnostic, 500);
    });
  </script>
</body>
</html>