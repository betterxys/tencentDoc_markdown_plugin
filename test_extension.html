<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ’ä»¶åŠŸèƒ½æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1557b0;
    }
    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .warning {
      color: orange;
      font-weight: bold;
    }
    .result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      background: white;
      border: 1px solid #eee;
    }
    .step {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-left: 4px solid #1a73e8;
    }
    .step h4 {
      margin: 0 0 10px 0;
      color: #1a73e8;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª è…¾è®¯æ–‡æ¡£ Markdown æŸ¥çœ‹å™¨æµ‹è¯•</h1>
  
  <div class="test-section">
    <h3>ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡</h3>
    <p>åœ¨å¼€å§‹æµ‹è¯•å‰ï¼Œè¯·ç¡®ä¿ï¼š</p>
    <ul>
      <li>Chromeç‰ˆæœ¬ â‰¥ 114</li>
      <li>æ‰©å±•å·²æ­£ç¡®å®‰è£…å¹¶å¯ç”¨</li>
      <li>å½“å‰åœ¨æ™®é€šç½‘é¡µä¸Šï¼ˆä¸æ˜¯Chromeå†…éƒ¨é¡µé¢ï¼‰</li>
    </ul>
    <button onclick="checkPrerequisites()">æ£€æŸ¥å‰ç½®æ¡ä»¶</button>
    <div id="prereq-result"></div>
  </div>

  <div class="test-section">
    <h3>ğŸ”§ è‡ªåŠ¨åŒ–æµ‹è¯•</h3>
    <p>è¿è¡Œå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•</p>
    <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    <div id="test-results"></div>
  </div>

  <div class="test-section">
    <h3>ğŸ“ æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤</h3>
    
    <div class="step">
      <h4>æ­¥éª¤1: æµ‹è¯•æ‰©å±•åŸºæœ¬åŠŸèƒ½</h4>
      <p>1. ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ ä¸­çš„æ’ä»¶å›¾æ ‡</p>
      <p>2. æ£€æŸ¥ä¾§è¾¹æ æ˜¯å¦æˆåŠŸæ‰“å¼€</p>
      <p>3. è§‚å¯Ÿä¾§è¾¹æ ä¸­æ˜¯å¦æ˜¾ç¤ºé»˜è®¤çš„"ç‚¹å‡»è…¾è®¯æ–‡æ¡£ä¸­çš„å•å…ƒæ ¼..."æç¤º</p>
      <button onclick="testBasicFunction()">éªŒè¯åŸºæœ¬åŠŸèƒ½</button>
      <div id="basic-result"></div>
    </div>

    <div class="step">
      <h4>æ­¥éª¤2: æµ‹è¯•è…¾è®¯æ–‡æ¡£é›†æˆ</h4>
      <p>1. æ‰“å¼€è…¾è®¯æ–‡æ¡£è¡¨æ ¼é¡µé¢</p>
      <p>2. åœ¨ä»»æ„å•å…ƒæ ¼ä¸­è¾“å…¥ä¸€äº›Markdownå†…å®¹ï¼Œä¾‹å¦‚ï¼š</p>
      <pre># æµ‹è¯•æ ‡é¢˜

è¿™æ˜¯ä¸€ä¸ª**ç²—ä½“**æµ‹è¯•ã€‚

| åˆ—1 | åˆ—2 |
|-----|-----|
| æ•°æ®1 | æ•°æ®2 |</pre>
      <p>3. ç‚¹å‡»è¯¥å•å…ƒæ ¼</p>
      <p>4. è§‚å¯Ÿä¾§è¾¹æ æ˜¯å¦æ˜¾ç¤ºæ¸²æŸ“åçš„Markdownå†…å®¹</p>
    </div>

    <div class="step">
      <h4>æ­¥éª¤3: æµ‹è¯•è°ƒè¯•åŠŸèƒ½</h4>
      <p>1. åœ¨ä¾§è¾¹æ ä¸­ç‚¹å‡»è°ƒè¯•æŒ‰é’®ï¼ˆé½¿è½®å›¾æ ‡ï¼‰</p>
      <p>2. æŸ¥çœ‹è°ƒè¯•æ—¥å¿—æ˜¯å¦æ­£å¸¸æ˜¾ç¤º</p>
      <p>3. å°è¯•å¤åˆ¶æ—¥å¿—åŠŸèƒ½</p>
    </div>
  </div>

  <div class="test-section">
    <h3>ğŸš¨ æ•…éšœæ’æŸ¥</h3>
    <p>å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ’æŸ¥ï¼š</p>
    
    <div class="step">
      <h4>æ£€æŸ¥èƒŒæ™¯è„šæœ¬æ—¥å¿—</h4>
      <p>1. æ‰“å¼€ <code>chrome://extensions/</code></p>
      <p>2. æ‰¾åˆ°æ‰©å±•ï¼Œç‚¹å‡»"è¯¦ç»†ä¿¡æ¯"</p>
      <p>3. åœ¨"æ£€æŸ¥è§†å›¾"éƒ¨åˆ†ç‚¹å‡»"èƒŒæ™¯è„šæœ¬"</p>
      <p>4. æŸ¥çœ‹Consoleä¸­çš„æ—¥å¿—è¾“å‡º</p>
      <button onclick="openExtensionPage()">æ‰“å¼€æ‰©å±•ç®¡ç†é¡µé¢</button>
    </div>

    <div class="step">
      <h4>è¿è¡Œè¯Šæ–­å·¥å…·</h4>
      <p>ä½¿ç”¨å†…ç½®çš„è¯Šæ–­é¡µé¢æ£€æŸ¥æ‰€æœ‰ç»„ä»¶çŠ¶æ€</p>
      <button onclick="openDiagnostic()">æ‰“å¼€è¯Šæ–­é¡µé¢</button>
    </div>

    <div class="step">
      <h4>æŸ¥çœ‹è¯¦ç»†æ•…éšœæ’æŸ¥æŒ‡å—</h4>
      <p>æŸ¥çœ‹å®Œæ•´çš„æ•…éšœæ’æŸ¥æ–‡æ¡£</p>
      <button onclick="showTroubleshooting()">æŸ¥çœ‹æ•…éšœæ’æŸ¥æŒ‡å—</button>
    </div>
  </div>

  <script>
    function log(message, type = 'info') {
      console.log(`[Test] ${message}`);
    }

    function showResult(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'warning';
      element.innerHTML = `<div class="result ${className}">${message}</div>`;
    }

    function checkPrerequisites() {
      log('æ£€æŸ¥å‰ç½®æ¡ä»¶...');
      
      const checks = {
        chrome: navigator.userAgent.includes('Chrome'),
        extension: !!window.chrome?.runtime,
        version: getChromeVersion() >= 114,
        page: !location.href.startsWith('chrome://')
      };

      let message = '<h4>å‰ç½®æ¡ä»¶æ£€æŸ¥ç»“æœ:</h4><ul>';
      let allPassed = true;

      Object.entries(checks).forEach(([key, passed]) => {
        const status = passed ? 'âœ…' : 'âŒ';
        const labels = {
          chrome: 'Chromeæµè§ˆå™¨',
          extension: 'æ‰©å±•APIå¯ç”¨',
          version: 'Chromeç‰ˆæœ¬ â‰¥ 114',
          page: 'åœ¨æ™®é€šç½‘é¡µä¸Š'
        };
        message += `<li>${status} ${labels[key]}</li>`;
        if (!passed) allPassed = false;
      });

      message += '</ul>';
      
      if (allPassed) {
        message += '<p class="success">âœ… æ‰€æœ‰å‰ç½®æ¡ä»¶æ»¡è¶³ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼</p>';
      } else {
        message += '<p class="error">âŒ éƒ¨åˆ†å‰ç½®æ¡ä»¶ä¸æ»¡è¶³ï¼Œè¯·å…ˆè§£å†³è¿™äº›é—®é¢˜</p>';
      }

      showResult('prereq-result', message);
    }

    function getChromeVersion() {
      const match = navigator.userAgent.match(/Chrome\/(\d+)/);
      return match ? parseInt(match[1]) : 0;
    }

    function testBasicFunction() {
      log('æµ‹è¯•åŸºæœ¬åŠŸèƒ½...');
      
      if (!window.chrome?.runtime) {
        showResult('basic-result', 'âŒ Chromeæ‰©å±•APIä¸å¯ç”¨', 'error');
        return;
      }

      // å°è¯•å‘é€æµ‹è¯•æ¶ˆæ¯
      chrome.runtime.sendMessage({
        type: 'debug_test',
        timestamp: Date.now()
      }, response => {
        if (chrome.runtime.lastError) {
          showResult('basic-result', `âŒ æ‰©å±•é€šä¿¡å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          showResult('basic-result', `âœ… æ‰©å±•é€šä¿¡æ­£å¸¸: ${JSON.stringify(response)}`, 'success');
        }
      });
    }

    function runAllTests() {
      log('è¿è¡Œæ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•...');
      
      const tests = [
        {
          name: 'æ£€æŸ¥Chrome API',
          test: () => !!window.chrome?.runtime
        },
        {
          name: 'æ£€æŸ¥ä¾§è¾¹æ API',
          test: () => !!window.chrome?.sidePanel
        },
        {
          name: 'æ£€æŸ¥å­˜å‚¨API',
          test: () => !!window.chrome?.storage
        },
        {
          name: 'æ£€æŸ¥æ ‡ç­¾é¡µAPI',
          test: () => !!window.chrome?.tabs
        }
      ];

      let results = '<h4>è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœ:</h4><ul>';
      let passed = 0;

      tests.forEach(({ name, test }) => {
        const result = test();
        const status = result ? 'âœ…' : 'âŒ';
        results += `<li>${status} ${name}</li>`;
        if (result) passed++;
      });

      results += `</ul><p>é€šè¿‡ç‡: ${passed}/${tests.length} (${Math.round(passed/tests.length*100)}%)</p>`;

      if (passed === tests.length) {
        results += '<p class="success">âœ… æ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡ï¼</p>';
      } else {
        results += '<p class="warning">âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½å½±å“æ’ä»¶åŠŸèƒ½</p>';
      }

      showResult('test-results', results);
    }

    function openExtensionPage() {
      window.open('chrome://extensions/', '_blank');
    }

    function openDiagnostic() {
      if (window.chrome?.runtime?.id) {
        const url = `chrome-extension://${chrome.runtime.id}/sidepanel_diagnostic.html`;
        window.open(url, '_blank');
      } else {
        alert('æ— æ³•è·å–æ‰©å±•IDï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€è¯Šæ–­é¡µé¢');
      }
    }

    function showTroubleshooting() {
      const troubleshootingContent = `
# å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³

## é—®é¢˜1: ç‚¹å‡»æ’ä»¶å›¾æ ‡æ²¡ååº”
- ç¡®ä¿åœ¨è…¾è®¯æ–‡æ¡£é¡µé¢æµ‹è¯•ï¼Œä¸æ˜¯Chromeå†…éƒ¨é¡µé¢
- æ£€æŸ¥Chromeç‰ˆæœ¬æ˜¯å¦ â‰¥ 114
- é‡æ–°åŠ è½½æ‰©å±•

## é—®é¢˜2: ä¾§è¾¹æ æ‰“å¼€ä½†ç©ºç™½
- æ£€æŸ¥lib/ç›®å½•ä¸‹çš„ä¾èµ–æ–‡ä»¶æ˜¯å¦å®Œæ•´
- æŸ¥çœ‹ä¾§è¾¹æ å¼€å‘è€…å·¥å…·çš„Consoleé”™è¯¯
- è¿è¡ŒcheckSidePanelStatus()è¯Šæ–­

## é—®é¢˜3: æ— æ³•æå–å•å…ƒæ ¼å†…å®¹
- æŒ‰F12æŸ¥çœ‹é¡µé¢Consoleä¸­çš„[Content]æ—¥å¿—
- å°è¯•å¿«æ·é”®Ctrl+Shift+Mæ‰‹åŠ¨è§¦å‘
- æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„è…¾è®¯æ–‡æ¡£é¡µé¢

æ›´å¤šè¯¦æƒ…è¯·æŸ¥çœ‹TROUBLESHOOTING.mdæ–‡ä»¶
      `;
      
      const newWindow = window.open('', '_blank');
      newWindow.document.write(`
        <html>
          <head><title>æ•…éšœæ’æŸ¥æŒ‡å—</title></head>
          <body style="font-family: monospace; padding: 20px; white-space: pre-wrap;">
            ${troubleshootingContent}
          </body>
        </html>
      `);
    }

    // é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æŸ¥å‰ç½®æ¡ä»¶
    document.addEventListener('DOMContentLoaded', () => {
      log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
      setTimeout(checkPrerequisites, 500);
    });
  </script>
</body>
</html>