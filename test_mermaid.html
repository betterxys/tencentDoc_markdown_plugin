<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid å›¾è¡¨æ¸²æŸ“æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005a87; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .mermaid-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            background: #f8f9fa;
            text-align: center;
            overflow-x: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ Mermaid å›¾è¡¨æ¸²æŸ“æµ‹è¯•</h1>
    <p>æµ‹è¯•æ–°æ·»åŠ çš„ Mermaid å›¾è¡¨æ¸²æŸ“åŠŸèƒ½</p>

    <div class="test-section">
        <h3>ğŸ“‹ æµ‹è¯•ç”¨ä¾‹</h3>
        <button onclick="testFlowchart()">æµ‹è¯•æµç¨‹å›¾</button>
        <button onclick="testSequence()">æµ‹è¯•åºåˆ—å›¾</button>
        <button onclick="testGantt()">æµ‹è¯•ç”˜ç‰¹å›¾</button>
        <button onclick="testMarkdownWithMermaid()">æµ‹è¯•å®Œæ•´ Markdown + Mermaid</button>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š æ¸²æŸ“ç»“æœ</h3>
        <div id="renderResult"></div>
    </div>

    <div class="test-section">
        <h3>âœ… éªŒè¯ç»“æœ</h3>
        <div id="validationResults"></div>
    </div>

    <script src="lib/markdown-it.min.js"></script>
    <script src="lib/purify.min.js"></script>
    <script src="lib/mermaid.min.js"></script>
    <script>
        // åˆå§‹åŒ– markdown-it
        const md = markdownit({
            html: false,
            breaks: true,
            linkify: true,
            typographer: true
        });

        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            htmlLabels: true,
            fontFamily: 'system-ui, -apple-system, sans-serif',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });

        // æµ‹è¯•ç”¨ä¾‹æ•°æ®
        const testCases = {
            flowchart: `# æœºå™¨äººå¨èƒæ„ŸçŸ¥æµç¨‹

\`\`\`mermaid
graph TB
  A[æœºå™¨äººå¨èƒæ„ŸçŸ¥] --> B{é£é™©ç­‰çº§è¯„ä¼°}
  B -- é«˜é£é™© --> C[è‡ªåŠ¨éš”ç¦»å—æ„ŸæŸ“æ¨¡å—]
  B -- ä¸­é£é™© --> D[T-ONEå¹³å°é¢„è­¦æ¨é€]
  C --> E[è§¦å‘ä¿é™©é¢„èµ”é€šé“]
  D --> F[å¤©åˆ›å®‰å…¨å›¢é˜Ÿä»‹å…¥åŠ å›º]
  E --> G[72å°æ—¶å†…æ”¯ä»˜50%é¢„ä¼°æŸå¤±]
\`\`\`

è¿™æ˜¯ä¸€ä¸ªå±•ç¤ºæœºå™¨äººå¨èƒæ„ŸçŸ¥ä¸ä¿é™©é¢„èµ”æµç¨‹çš„å›¾è¡¨ã€‚`,

            sequence: `# ç”¨æˆ·äº¤äº’åºåˆ—

\`\`\`mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant System as ç³»ç»Ÿ
    participant AI as AIåŠ©æ‰‹
    participant DB as æ•°æ®åº“
    
    User->>System: æäº¤é—®é¢˜
    System->>AI: è½¬å‘è¯·æ±‚
    AI->>DB: æŸ¥è¯¢ç›¸å…³æ•°æ®
    DB-->>AI: è¿”å›æ•°æ®
    AI->>AI: å¤„ç†å’Œåˆ†æ
    AI-->>System: ç”Ÿæˆå›å¤
    System-->>User: è¿”å›ç­”æ¡ˆ
\`\`\`

è¿™å±•ç¤ºäº†ç³»ç»Ÿçš„äº¤äº’æµç¨‹ã€‚`,

            gantt: `# é¡¹ç›®æ—¶é—´çº¿

\`\`\`mermaid
gantt
    title é¡¹ç›®å¼€å‘è®¡åˆ’
    dateFormat  YYYY-MM-DD
    section éœ€æ±‚åˆ†æ
    éœ€æ±‚æ”¶é›†           :done,    des1, 2024-01-01,2024-01-15
    éœ€æ±‚åˆ†æ           :done,    des2, 2024-01-10, 10d
    section å¼€å‘é˜¶æ®µ
    å‰ç«¯å¼€å‘           :active,  dev1, 2024-01-20, 20d
    åç«¯å¼€å‘           :         dev2, 2024-01-25, 25d
    section æµ‹è¯•éƒ¨ç½²
    ç³»ç»Ÿæµ‹è¯•           :         test1, after dev2, 10d
    éƒ¨ç½²ä¸Šçº¿           :         deploy, after test1, 5d
\`\`\`

è¿™æ˜¯é¡¹ç›®çš„å¼€å‘æ—¶é—´çº¿ã€‚`
        };

        function testFlowchart() {
            renderTest('æµç¨‹å›¾', testCases.flowchart);
        }

        function testSequence() {
            renderTest('åºåˆ—å›¾', testCases.sequence);
        }

        function testGantt() {
            renderTest('ç”˜ç‰¹å›¾', testCases.gantt);
        }

        function testMarkdownWithMermaid() {
            const complexContent = `# ç»¼åˆæµ‹è¯•æ–‡æ¡£

## 1. æµç¨‹å›¾ç¤ºä¾‹
${testCases.flowchart}

## 2. åˆ—è¡¨å†…å®¹
- ç¬¬ä¸€é¡¹å†…å®¹
- ç¬¬äºŒé¡¹å†…å®¹
- **é‡è¦**ï¼šè¿™é‡ŒåŒ…å«ç²—ä½“æ–‡æœ¬

## 3. è¡¨æ ¼ç¤ºä¾‹
| åŠŸèƒ½ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| Markdown æ¸²æŸ“ | âœ… å·²å®Œæˆ | åŸºæœ¬åŠŸèƒ½æ­£å¸¸ |
| Mermaid å›¾è¡¨ | ğŸ§ª æµ‹è¯•ä¸­ | æ–°åŠŸèƒ½æµ‹è¯• |
| è¡¨æ ¼æ¸²æŸ“ | âœ… å·²å®Œæˆ | æ”¯æŒå¤æ‚è¡¨æ ¼ |

## 4. ä»£ç ç¤ºä¾‹
\`\`\`javascript
function renderMermaid() {
    console.log('æ­£åœ¨æ¸²æŸ“ Mermaid å›¾è¡¨...');
}
\`\`\`

è¿™æ˜¯ä¸€ä¸ªåŒ…å«å¤šç§å…ƒç´ çš„ç»¼åˆæµ‹è¯•æ–‡æ¡£ã€‚`;
            
            renderTest('ç»¼åˆæµ‹è¯•', complexContent);
        }

        function renderTest(testName, content) {
            console.log(`å¼€å§‹æµ‹è¯•: ${testName}`);
            
            // æ˜¾ç¤ºåŸå§‹å†…å®¹
            const resultDiv = document.getElementById('renderResult');
            resultDiv.innerHTML = `
                <h4>ğŸ” æµ‹è¯•: ${testName}</h4>
                <details>
                    <summary>æŸ¥çœ‹åŸå§‹ Markdown å†…å®¹</summary>
                    <pre>${escapeHtml(content)}</pre>
                </details>
                <h5>æ¸²æŸ“ç»“æœ:</h5>
                <div id="renderedContent"></div>
            `;
            
            try {
                // ä½¿ç”¨ markdown-it æ¸²æŸ“
                const html = md.render(content);
                
                // ä½¿ç”¨ DOMPurify æ¸…ç† HTML
                const cleanHtml = DOMPurify.sanitize(html, {
                    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'div', 'span', 'strong', 'em', 'u', 'code', 'pre', 'ul', 'ol', 'li', 'blockquote', 'a', 'img', 'br', 'hr', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'svg', 'g', 'path', 'circle', 'rect', 'line', 'text', 'tspan', 'defs', 'marker', 'polygon', 'polyline', 'ellipse', 'use', 'foreignObject'],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'align', 'style', 'colspan', 'rowspan', 'viewBox', 'width', 'height', 'x', 'y', 'dx', 'dy', 'fill', 'stroke', 'stroke-width', 'stroke-dasharray', 'transform', 'd', 'cx', 'cy', 'r', 'rx', 'ry', 'x1', 'y1', 'x2', 'y2', 'points', 'marker-end', 'marker-start', 'text-anchor', 'dominant-baseline', 'font-family', 'font-size', 'font-weight', 'xmlns', 'xmlns:xlink', 'xlink:href']
                });
                
                document.getElementById('renderedContent').innerHTML = cleanHtml;
                
                // å¤„ç† Mermaid å›¾è¡¨
                setTimeout(() => {
                    processMermaidDiagrams();
                    validateResults(testName, content);
                }, 100);
                
            } catch (error) {
                console.error('æ¸²æŸ“é”™è¯¯:', error);
                document.getElementById('renderedContent').innerHTML = `
                    <div style="color: #dc3545; padding: 10px; border: 1px solid #dc3545; border-radius: 4px;">
                        <strong>æ¸²æŸ“å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function processMermaidDiagrams() {
            // æŸ¥æ‰¾æ‰€æœ‰ Mermaid ä»£ç å—
            const mermaidBlocks = document.querySelectorAll('#renderedContent pre code.language-mermaid, #renderedContent pre code[class*="mermaid"]');
            
            console.log(`æ‰¾åˆ° ${mermaidBlocks.length} ä¸ª Mermaid å›¾è¡¨`);
            
            if (mermaidBlocks.length === 0) {
                return;
            }

            mermaidBlocks.forEach((codeBlock, index) => {
                const pre = codeBlock.parentElement;
                const mermaidCode = codeBlock.textContent.trim();
                
                if (!mermaidCode) {
                    console.log(`Mermaid å›¾è¡¨ ${index + 1} ä¸ºç©ºï¼Œè·³è¿‡`);
                    return;
                }

                console.log(`å¤„ç† Mermaid å›¾è¡¨ ${index + 1}: ${mermaidCode.substring(0, 50)}...`);

                // åˆ›å»ºå®¹å™¨
                const mermaidContainer = document.createElement('div');
                mermaidContainer.className = 'mermaid-container';

                const mermaidDiv = document.createElement('div');
                const diagramId = `mermaid-diagram-test-${Date.now()}-${index}`;
                mermaidDiv.id = diagramId;
                mermaidDiv.className = 'mermaid';

                // æ¸²æŸ“ Mermaid å›¾è¡¨
                mermaid.render(diagramId + '-svg', mermaidCode).then(result => {
                    if (result && result.svg) {
                        mermaidDiv.innerHTML = result.svg;
                        console.log(`Mermaid å›¾è¡¨ ${index + 1} æ¸²æŸ“æˆåŠŸ`);
                    } else {
                        throw new Error('æ¸²æŸ“ç»“æœä¸ºç©º');
                    }
                }).catch(error => {
                    console.error(`Mermaid å›¾è¡¨ ${index + 1} æ¸²æŸ“å¤±è´¥:`, error);
                    mermaidDiv.innerHTML = `
                        <div style="color: #d73a49; padding: 10px; font-size: 14px;">
                            <strong>Mermaid å›¾è¡¨æ¸²æŸ“å¤±è´¥:</strong><br>
                            ${escapeHtml(error.message)}<br>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer;">æŸ¥çœ‹åŸå§‹ä»£ç </summary>
                                <pre style="background: #f1f1f1; padding: 10px; margin-top: 5px; text-align: left; white-space: pre-wrap;">${escapeHtml(mermaidCode)}</pre>
                            </details>
                        </div>
                    `;
                });

                // æ·»åŠ æ ‡é¢˜
                const title = document.createElement('div');
                title.style.cssText = `
                    font-size: 14px;
                    color: #586069;
                    margin-bottom: 10px;
                    font-weight: 500;
                `;
                title.textContent = `ğŸ“Š Mermaid å›¾è¡¨ ${index + 1}`;

                mermaidContainer.appendChild(title);
                mermaidContainer.appendChild(mermaidDiv);

                // æ›¿æ¢åŸæ¥çš„ pre å…ƒç´ 
                pre.parentNode.replaceChild(mermaidContainer, pre);
            });
        }

        function validateResults(testName, content) {
            setTimeout(() => {
                const hasMermaidContainers = document.querySelectorAll('#renderedContent .mermaid-container').length > 0;
                const hasRenderedSVG = document.querySelectorAll('#renderedContent .mermaid-container svg').length > 0;
                const hasTable = document.querySelectorAll('#renderedContent table').length > 0;
                const hasHeaders = document.querySelectorAll('#renderedContent h1, #renderedContent h2, #renderedContent h3').length > 0;
                
                const results = `
                    <h4>ğŸ” ${testName} éªŒè¯ç»“æœ:</h4>
                    <p><strong>Mermaid å®¹å™¨:</strong> 
                        ${hasMermaidContainers ? '<span class="success">âœ… æ‰¾åˆ°</span>' : '<span class="error">âŒ æœªæ‰¾åˆ°</span>'}
                    </p>
                    <p><strong>SVG å›¾è¡¨:</strong> 
                        ${hasRenderedSVG ? '<span class="success">âœ… æ¸²æŸ“æˆåŠŸ</span>' : '<span class="error">âŒ æ¸²æŸ“å¤±è´¥</span>'}
                    </p>
                    <p><strong>è¡¨æ ¼æ¸²æŸ“:</strong> 
                        ${hasTable ? '<span class="success">âœ… æ­£å¸¸</span>' : (content.includes('|') ? '<span class="error">âŒ å¤±è´¥</span>' : 'ğŸš« æ— è¡¨æ ¼')}
                    </p>
                    <p><strong>æ ‡é¢˜æ¸²æŸ“:</strong> 
                        ${hasHeaders ? '<span class="success">âœ… æ­£å¸¸</span>' : '<span class="error">âŒ å¤±è´¥</span>'}
                    </p>
                    
                    <h5>ğŸ“Š æ€»ä½“è¯„ä¼°:</h5>
                    <p>${hasRenderedSVG ? 
                        '<span class="success">ğŸ‰ Mermaid å›¾è¡¨æ¸²æŸ“æˆåŠŸï¼åŠŸèƒ½æ­£å¸¸å·¥ä½œ</span>' : 
                        '<span class="error">âš ï¸ Mermaid å›¾è¡¨æ¸²æŸ“å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•</span>'}</p>
                `;
                
                document.getElementById('validationResults').innerHTML = results;
                
                console.log(`${testName} éªŒè¯å®Œæˆ:`, {
                    hasMermaidContainers,
                    hasRenderedSVG,
                    hasTable,
                    hasHeaders
                });
            }, 2000); // ç­‰å¾… Mermaid æ¸²æŸ“å®Œæˆ
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Mermaid æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            console.log('Mermaid ç‰ˆæœ¬:', typeof mermaid !== 'undefined' ? 'loaded' : 'not loaded');
            console.log('Markdown-it ç‰ˆæœ¬:', typeof markdownit !== 'undefined' ? 'loaded' : 'not loaded');
            console.log('DOMPurify ç‰ˆæœ¬:', typeof DOMPurify !== 'undefined' ? 'loaded' : 'not loaded');
        });
    </script>
</body>
</html>