<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>markdown-it è¡¨æ ¼æ¸²æŸ“æµ‹è¯•</title>
    <script src="lib/markdown-it.min.js"></script>
    <script src="lib/purify.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .test-header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 30px 0;
            border: 2px solid #007bff;
            padding: 25px;
            border-radius: 10px;
            background-color: #f8f9fa;
        }
        
        .result-container {
            border: 2px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background-color: white;
            min-height: 200px;
        }
        
        .debug-section {
            background: #343a40;
            color: #00ff41;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        /* å¢å¼ºçš„è¡¨æ ¼æ ·å¼ */
        table {
            border-collapse: collapse !important;
            width: 100% !important;
            margin: 20px 0 !important;
            border: 2px solid #2196f3 !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        th {
            padding: 15px !important;
            text-align: left !important;
            background: linear-gradient(135deg, #2196f3, #1976d2) !important;
            color: white !important;
            font-weight: 600 !important;
            border: 1px solid #1976d2 !important;
        }
        
        td {
            padding: 12px 15px !important;
            border: 1px solid #e0e0e0 !important;
            background-color: #ffffff !important;
            vertical-align: top !important;
        }
        
        tr:nth-child(even) td {
            background-color: #f5f5f5 !important;
        }
        
        tr:hover td {
            background-color: #e3f2fd !important;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        
        .custom-input {
            margin-bottom: 20px;
            padding: 20px;
            border: 2px dashed #28a745;
            border-radius: 8px;
            background-color: #f8fff4;
        }
        
        .custom-textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-header">
            <h1>ğŸš€ markdown-it è¡¨æ ¼æ¸²æŸ“æµ‹è¯•</h1>
            <p>æµ‹è¯•æ–°çš„ markdown-it è§£æå™¨å¯¹è¡¨æ ¼çš„æ”¯æŒ</p>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•é€‰é¡¹</h2>
            <button class="btn" onclick="testFailingContent()">ğŸ§ª æµ‹è¯•å¤±è´¥å†…å®¹</button>
            <button class="btn" onclick="testSimpleTable()">ğŸ“Š æµ‹è¯•ç®€å•è¡¨æ ¼</button>
            <button class="btn" onclick="testComplexTable()">ğŸ”§ æµ‹è¯•å¤æ‚è¡¨æ ¼</button>
            <button class="btn" onclick="toggleCustomInput()">âœï¸ è‡ªå®šä¹‰æµ‹è¯•</button>
            
            <div id="custom-input-section" class="custom-input" style="display: none;">
                <h3 style="margin-top: 0; color: #28a745;">âœï¸ è¾“å…¥è‡ªå®šä¹‰æµ‹è¯•å†…å®¹</h3>
                <textarea id="custom-content" placeholder="åœ¨è¿™é‡Œç²˜è´´æ‚¨è¦æµ‹è¯•çš„Markdownå†…å®¹..." class="custom-textarea"></textarea>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="testCustomContent()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ğŸ§ª æ‰§è¡Œè‡ªå®šä¹‰æµ‹è¯•</button>
                    <button class="btn" onclick="toggleCustomInput()" style="background: #6c757d;">âŒ å…³é—­</button>
                </div>
            </div>
            
            <div class="stats-grid" id="stats-grid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="stat-success">-</div>
                    <div class="stat-label">æ¸²æŸ“æˆåŠŸ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-tables">-</div>
                    <div class="stat-label">è¡¨æ ¼æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-rows">-</div>
                    <div class="stat-label">è¡¨æ ¼è¡Œæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-cells">-</div>
                    <div class="stat-label">è¡¨æ ¼å•å…ƒæ ¼</div>
                </div>
            </div>
            
            <div class="result-container" id="result-container">
                <p style="text-align: center; color: #666;">é€‰æ‹©ä¸Šé¢çš„æµ‹è¯•æŒ‰é’®å¼€å§‹æµ‹è¯•</p>
            </div>
            
            <details>
                <summary style="cursor: pointer; font-weight: bold; color: #1976d2;">ğŸ“Š æŸ¥çœ‹è¯¦ç»†è°ƒè¯•ä¿¡æ¯</summary>
                <div class="debug-section" id="debug-log"></div>
            </details>
        </div>
    </div>
    
    <script>
        // åˆå§‹åŒ–markdown-it
        let md;
        
        window.onload = function() {
            try {
                md = markdownit({
                    html: false,
                    xhtmlOut: false,
                    breaks: false,
                    langPrefix: 'language-',
                    linkify: true,
                    typographer: true,
                    quotes: '""''',
                });
                
                log('âœ… markdown-it åˆå§‹åŒ–æˆåŠŸ');
                log(`ğŸ“š markdown-it ç‰ˆæœ¬: ${markdownit.version || 'unknown'}`);
                
            } catch (error) {
                log(`âŒ markdown-it åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        };
        
        function log(message, level = 'info') {
            const debugDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const icons = {
                'success': 'âœ…',
                'error': 'âŒ', 
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            };
            const icon = icons[level] || 'â„¹ï¸';
            debugDiv.textContent += `[${timestamp}] ${icon} ${message}\n`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }
        
        function updateStats(success, tablesCount, rowsCount, cellsCount) {
            document.getElementById('stat-success').textContent = success ? 'âœ…' : 'âŒ';
            document.getElementById('stat-success').className = success ? 'stat-value success' : 'stat-value error';
            
            document.getElementById('stat-tables').textContent = tablesCount;
            document.getElementById('stat-rows').textContent = rowsCount;
            document.getElementById('stat-cells').textContent = cellsCount;
            
            document.getElementById('stats-grid').style.display = 'grid';
        }
        
        function toggleCustomInput() {
            const section = document.getElementById('custom-input-section');
            if (section.style.display === 'none') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }
        
        function renderMarkdown(content, testName) {
            clearLog();
            log(`ğŸš€ å¼€å§‹æµ‹è¯•: ${testName}`);
            log(`ğŸ“ å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);
            
            try {
                // ä½¿ç”¨markdown-itæ¸²æŸ“
                const html = md.render(content);
                log('âœ… markdown-it æ¸²æŸ“æˆåŠŸ', 'success');
                log(`ğŸ“„ ç”ŸæˆHTMLé•¿åº¦: ${html.length} å­—ç¬¦`);
                log(`ğŸ” åŒ…å«<table>æ ‡ç­¾: ${/<table/.test(html)}`, /<table/.test(html) ? 'success' : 'error');
                
                // ä½¿ç”¨DOMPurifyæ¸…ç†
                const cleanHtml = DOMPurify.sanitize(html, {
                    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'div', 'span', 'strong', 'em', 'u', 'code', 'pre', 'ul', 'ol', 'li', 'blockquote', 'a', 'img', 'br', 'hr', 'table', 'thead', 'tbody', 'tr', 'th', 'td'],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'align', 'style', 'colspan', 'rowspan']
                });
                
                log(`ğŸ§¹ DOMPurifyæ¸…ç†åé•¿åº¦: ${cleanHtml.length} å­—ç¬¦`);
                log(`ğŸ” æœ€ç»ˆåŒ…å«<table>æ ‡ç­¾: ${/<table/.test(cleanHtml)}`, /<table/.test(cleanHtml) ? 'success' : 'error');
                
                // æ¸²æŸ“åˆ°é¡µé¢
                document.getElementById('result-container').innerHTML = cleanHtml;
                
                // éªŒè¯æ¸²æŸ“ç»“æœ
                const tables = document.getElementById('result-container').querySelectorAll('table');
                const totalRows = document.getElementById('result-container').querySelectorAll('tr');
                const totalCells = document.getElementById('result-container').querySelectorAll('th, td');
                
                log(`ğŸ“Š å®é™…æ¸²æŸ“çš„è¡¨æ ¼æ•°é‡: ${tables.length}`, tables.length > 0 ? 'success' : 'error');
                log(`ğŸ“‹ æ€»è¡Œæ•°: ${totalRows.length}`);
                log(`ğŸ”¢ æ€»å•å…ƒæ ¼æ•°: ${totalCells.length}`);
                
                if (tables.length > 0) {
                    tables.forEach((table, i) => {
                        const headers = table.querySelectorAll('th');
                        const cells = table.querySelectorAll('td');
                        const rows = table.querySelectorAll('tr');
                        log(`ğŸ“‹ è¡¨æ ¼${i+1}: ${rows.length}è¡Œ, ${headers.length}ä¸ªè¡¨å¤´, ${cells.length}ä¸ªæ•°æ®å•å…ƒæ ¼`, 'success');
                    });
                }
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateStats(tables.length > 0, tables.length, totalRows.length, totalCells.length);
                
                if (tables.length > 0) {
                    log('ğŸ‰ æµ‹è¯•æˆåŠŸï¼è¡¨æ ¼å·²æ­£ç¡®æ¸²æŸ“', 'success');
                } else {
                    log('âŒ æµ‹è¯•å¤±è´¥ï¼è¡¨æ ¼æœªèƒ½æ¸²æŸ“', 'error');
                }
                
            } catch (error) {
                log(`âŒ æ¸²æŸ“é”™è¯¯: ${error.message}`, 'error');
                document.getElementById('result-container').innerHTML = 
                    `<div style="color: red; font-weight: bold; text-align: center; padding: 40px;">
                        âŒ æ¸²æŸ“å¤±è´¥: ${error.message}
                    </div>`;
                updateStats(false, 0, 0, 0);
            }
            
            log('ğŸ“ æµ‹è¯•å®Œæˆ');
        }
        
        function testFailingContent() {
            const failingContent = `### âš™ï¸ **ä¸€ã€è¡Œä¸šé£é™©ç‰¹æ€§ä¸ä¿é™©éœ€æ±‚**

| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** | **ç½‘å®‰é™©ä¿éšœé‡ç‚¹** | **æ”¿ç­–ä¾æ®** |

|----------|------------------|-------------------|-------------|

| **åŒ–å·¥è¡Œä¸š** | å·¥æ§ç³»ç»Ÿï¼ˆDCS/SISï¼‰é­å‹’ç´¢æ”»å‡»å¯¼è‡´ç”Ÿäº§ä¸­æ–­ï¼›å·¥è‰ºå‚æ•°æ³„éœ²å¼•å‘å®‰å…¨äº‹æ•…ï¼›ç¯ä¿æ•°æ®ç¯¡æ”¹æ‹›è‡´ç›‘ç®¡ç½šæ¬¾ | è¦†ç›–åœäº§æŸå¤±ï¼ˆæ—¥å‡äº§å€¼Ã—åœæœºå¤©æ•°ï¼‰+ æ•°æ®æ¢å¤è´¹ç”¨ + ç¬¬ä¸‰æ–¹è´£ä»»èµ”å¿ï¼ˆå¦‚ç¯å¢ƒæ±¡æŸ“ï¼‰ | ã€Šå·¥ä¸šæ§åˆ¶ç³»ç»Ÿä¿¡æ¯å®‰å…¨é˜²æŠ¤æŒ‡å—ã€‹[citation:7]ï¼›ã€Šç½‘ç»œå®‰å…¨æ³•ã€‹[citation:7] |

| **ç”µåŠ›è¡Œä¸š** | ç”µç½‘ç›‘æ§ç³»ç»Ÿè¢«å…¥ä¾µå¼•å‘å¤§é¢ç§¯åœç”µï¼›æ–°èƒ½æºç”µç«™é­DDoSæ”»å‡»è‡´è„±ç½‘ï¼›ç”¨æˆ·æ•°æ®æ³„éœ²é¢ä¸´èƒ½ç›‘ç½šæ¬¾ | èµ”å¿ç”µç½‘ç˜«ç—ªç½šæ¬¾ï¼ˆå•æ¬¡æœ€é«˜500ä¸‡ï¼‰ + å‘ç”µæŸå¤±ï¼ˆæŒ‰ä¸Šç½‘ç”µä»·è®¡ç®—ï¼‰ + åˆè§„ç½šé‡‘ | ã€Šç”µåŠ›å¯é æ€§ç®¡ç†åŠæ³•ã€‹è¦æ±‚å¼ºåŒ–ç›‘æ§ç³»ç»Ÿé˜²æŠ¤[citation:9] |`;
            
            renderMarkdown(failingContent, 'ç”¨æˆ·å¤±è´¥å†…å®¹ï¼ˆå¸¦ç©ºè¡Œè¡¨æ ¼ï¼‰');
        }
        
        function testSimpleTable() {
            const simpleContent = `# ç®€å•è¡¨æ ¼æµ‹è¯•

| A | B | C |
|---|---|---|
| 1 | 2 | 3 |
| 4 | 5 | 6 |`;
            
            renderMarkdown(simpleContent, 'ç®€å•è¡¨æ ¼');
        }
        
        function testComplexTable() {
            const complexContent = `#### **2. è¡Œä¸šä¸“å±é™„åŠ é™©**

| **è¡Œä¸š**   | **é™„åŠ é™©ç§**                | **è§¦å‘æ¡ä»¶**                          | **æ¡ˆä¾‹å‚è€ƒ** |
|------------|----------------------------|---------------------------------------|-------------|
| **åŒ–å·¥**    | å·¥è‰ºå‚æ•°ç¯¡æ”¹è´£ä»»é™©          | å› æœºå™¨äººä¼ è¾“æ•°æ®è¢«ç¯¡æ”¹å¼•å‘ç”Ÿäº§äº‹æ•…      | æŸç‚¼æ²¹å‚å› æ§åˆ¶ç³»ç»Ÿé­å…¥ä¾µè‡´æ³„æ¼ï¼Œèµ”ä»˜1200ä¸‡[citation:8] |
| **ç”µåŠ›**    | æ–°èƒ½æºåœºç«™è„±ç½‘æŸå¤±é™©        | é£ç”µåœº/å…‰ä¼ç”µç«™å› æ”»å‡»è„±ç½‘å¯¼è‡´çš„å‘ç”µè¡¥å¿ | å±±ä¸œå…±ä¿ä½“è¦†ç›–å…‰ä¼ç”µç«™åœæœºæŸå¤±[citation:3] |`;
            
            renderMarkdown(complexContent, 'å¤æ‚è¡¨æ ¼ï¼ˆæ— ç©ºè¡Œï¼‰');
        }
        
        function testCustomContent() {
            const customContent = document.getElementById('custom-content').value.trim();
            if (!customContent) {
                alert('è¯·å…ˆè¾“å…¥è¦æµ‹è¯•çš„å†…å®¹ï¼');
                return;
            }
            
            renderMarkdown(customContent, 'è‡ªå®šä¹‰å†…å®¹');
        }
    </script>
</body>
</html>