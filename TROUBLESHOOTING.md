# 🛠️ 腾讯文档 Markdown 查看器故障排查指南

## 🚨 常见问题：点击插件图标后Markdown预览区域无法展示

### 📋 问题症状
- 点击浏览器工具栏中的插件图标
- 侧边栏没有打开，或者打开了但内容区域是空白的
- 没有看到Markdown渲染效果

### 🔍 快速诊断步骤

#### 步骤1: 确认测试环境
**✅ 确保在正确的页面测试**
- ✅ 必须在腾讯文档表格页面测试：`doc.weixin.qq.com/sheet*`
- ❌ 不要在Chrome扩展管理页面(`chrome://extensions/`)测试
- ❌ 不要在Chrome内部页面(`chrome://`)测试

**正确的测试流程:**
1. 打开腾讯文档表格页面
2. 点击插件图标
3. 观察侧边栏是否打开

#### 步骤2: 检查Chrome版本
**要求: Chrome 114+ 版本**
```
在地址栏输入: chrome://version/
检查Chrome版本是否 >= 114
```

#### 步骤3: 检查扩展加载状态
1. 打开 `chrome://extensions/`
2. 找到"腾讯文档 Markdown 查看器"
3. 确认扩展已启用（开关为蓝色）
4. 检查是否有红色错误提示

### 🔧 详细排查流程

#### 1. 获取背景脚本日志
**这是最重要的诊断步骤！**

1. **打开扩展管理页面**
   - 地址栏输入: `chrome://extensions/`
   
2. **找到扩展并点击"详细信息"**
   
3. **查看背景脚本**
   - 在"检查视图"部分，点击"背景脚本"
   - 这会打开一个开发者工具窗口
   
4. **查看控制台日志**
   - 在Console标签中查看日志
   - 预期看到的日志：
     ```
     🚀 开始启动侧边栏...
     ✅ DOM元素初始化成功
     ✅ markdown-it初始化成功
     🎉 侧边栏启动完成!
     ```

5. **测试点击事件**
   - 保持背景脚本控制台开启
   - 在腾讯文档页面点击插件图标
   - 观察新增的日志输出

#### 2. 使用诊断工具
**新增的诊断页面可以帮助快速定位问题**

1. **打开诊断页面**
   - 在地址栏输入: `chrome-extension://[扩展ID]/sidepanel_diagnostic.html`
   - 或者在扩展详情页面找到"检查视图"部分的链接
   
2. **运行诊断**
   - 点击"运行完整诊断"按钮
   - 查看各项检查结果
   - 重点关注红色❌标记的项目

#### 3. 检查侧边栏初始化
如果侧边栏打开了但是内容空白：

1. **打开侧边栏的开发者工具**
   - 右键点击侧边栏区域
   - 选择"检查"或"Inspect"
   
2. **查看控制台错误**
   - 在Console标签查看是否有JavaScript错误
   - 常见错误包括：
     - `markdownit is not defined`
     - `DOM element not found`
     - `TypeError: Cannot read property`

3. **运行内置诊断**
   - 在侧边栏控制台输入: `checkSidePanelStatus()`
   - 查看返回的状态报告

### 🚑 常见问题解决方案

#### 问题1: 侧边栏无法打开
**症状**: 点击插件图标没有任何反应

**可能原因**:
- 不在支持的页面上测试
- Chrome版本过低
- 扩展权限不足

**解决方案**:
1. 确保在腾讯文档表格页面测试
2. 更新Chrome到最新版本
3. 重新安装扩展
4. 检查背景脚本日志中的错误信息

#### 问题2: 侧边栏打开但内容空白
**症状**: 侧边栏区域显示但没有内容或只显示"点击腾讯文档中的单元格..."

**可能原因**:
- DOM元素初始化失败
- JavaScript依赖库加载失败
- 初始化过程中出现错误

**解决方案**:
1. 检查`lib/`目录下的文件是否完整：
   ```bash
   ls -la lib/
   # 应该看到:
   # markdown-it.min.js (约100KB)
   # purify.min.js (约20KB) 
   # mermaid.min.js (约2.9MB)
   ```

2. 如果文件缺失，重新下载：
   ```bash
   curl -o lib/markdown-it.min.js https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js
   curl -o lib/purify.min.js https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js
   curl -o lib/mermaid.min.js https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js
   ```

3. 重新加载扩展

#### 问题3: Content Script无法提取内容
**症状**: 侧边栏正常但点击单元格没有内容显示

**可能原因**:
- Content script注入失败
- 腾讯文档页面结构变化
- 事件监听器设置失败

**解决方案**:
1. 检查页面控制台日志：
   - 在腾讯文档页面按F12
   - 查看Console中是否有`[Content]`开头的日志
   
2. 手动触发内容提取：
   - 按`Ctrl+Shift+M`（或Mac上`Cmd+Shift+M`）
   
3. 检查页面权限和域名匹配

### 🔍 高级调试

#### 使用调试函数
在侧边栏控制台中可以使用以下调试函数：

```javascript
// 检查侧边栏状态
checkSidePanelStatus()

// 测试表格渲染
testTableRendering()

// 测试内容检测
testContentTableDetection()

// 调试当前内容
debugCurrentContent()
```

#### 检查消息传递
```javascript
// 在content script中测试消息发送
chrome.runtime.sendMessage({
  type: 'markdown_content',
  content: '# 测试内容\n\n这是测试。'
})

// 在background script中检查接收
// (在背景脚本控制台中观察日志)
```

### 📞 获取技术支持

如果以上步骤都无法解决问题，请收集以下信息：

#### 必要信息:
1. **Chrome版本**: 在`chrome://version/`获取
2. **操作系统**: Windows/Mac/Linux及版本
3. **扩展版本**: 在扩展管理页面查看
4. **错误现象**: 详细描述问题症状

#### 诊断日志:
1. **背景脚本日志**: 从背景脚本控制台复制
2. **侧边栏日志**: 从侧边栏开发者工具复制
3. **Content script日志**: 从页面控制台复制
4. **诊断报告**: 运行`checkSidePanelStatus()`的结果

#### 复现步骤:
1. 具体的操作步骤
2. 测试的网页URL
3. 预期行为 vs 实际行为

### 💡 预防措施

#### 日常使用建议:
1. **定期更新**: 保持Chrome和扩展为最新版本
2. **清理缓存**: 定期清理浏览器缓存
3. **权限检查**: 确保扩展有必要的权限
4. **环境一致**: 始终在腾讯文档页面使用插件

#### 开发维护:
1. **备份配置**: 保存扩展设置和配置
2. **监控日志**: 注意控制台中的警告和错误
3. **测试流程**: 新版本发布前完整测试所有功能

---

## 🎯 **最新修复说明 (v1.3.3)**

### 📋 **用户手势上下文修复**

#### **修复的关键问题**
1. **用户手势上下文丢失** - 移除setTimeout延迟，保持Chrome安全要求
2. **过度复杂化的API调用** - 简化为直接调用sidePanel.open()
3. **不必要的预配置步骤** - 依赖manifest.json的全局配置
4. **错误处理优化** - 针对性处理，避免复杂的重复修复逻辑

#### **解决的具体错误**
- ✅ `sidePanel.open() may only be called in response to a user gesture` 错误
- ✅ 复杂的预配置导致的时序问题
- ✅ Promise链中setTimeout破坏用户手势上下文
- ✅ 过度工程化导致的API调用复杂性

### 🚀 **新的简化流程**

1. **直接调用模式**
   ```
   用户点击插件图标 → 直接调用 sidePanel.open() → 成功打开
   ```

2. **去除的复杂逻辑**
   - ❌ 预配置 setOptions() 步骤
   - ❌ 100ms setTimeout 延迟
   - ❌ 复杂的状态同步等待
   - ❌ 多层Promise嵌套

3. **保留的核心功能**
   - ✅ 基本错误处理和日志记录
   - ✅ 侧边栏初始化检测
   - ✅ 简单的状态重置机制

### ⚡ **性能改进**

- 打开速度更快（去除100ms延迟）
- 更可靠的用户手势上下文保持
- 减少API调用次数，降低出错概率
- 符合Chrome扩展最佳实践

### 🆘 **如果问题仍然存在**

请提供以下诊断信息：
1. 重新加载扩展后的背景脚本初始化日志
2. 点击图标时的完整日志（应该更简洁了）
3. Chrome版本信息和操作系统

**经过这次修复，插件应该能可靠、快速地打开侧边栏了！**

---

## 🎯 **历史修复说明 (v1.3.1)**

### 📋 **核心问题已修复**

#### **修复的关键问题**
1. **标签页监听逻辑优化** - 避免扩展自身页面触发禁用逻辑
2. **侧边栏状态管理增强** - 更可靠的初始化检测和状态跟踪  
3. **自动修复机制** - 当侧边栏打开失败时自动重置配置
4. **扩展安装时强制重置** - 确保每次加载都有干净的状态

#### **解决的具体错误**
- ✅ `No active side panel for tabId` 错误
- ✅ 访问侧边栏页面时错误禁用的问题
- ✅ 用户手势上下文丢失问题
- ✅ 状态同步混乱问题

### 🚀 **重新测试步骤**

1. **重新加载扩展**
   ```
   打开 chrome://extensions/
   找到扩展，点击"重新加载"按钮
   ```

2. **验证初始化日志**
   - 在背景脚本控制台应该看到：
   ```
   ✅ 侧边栏全局配置已重置
   🔧 为 X 个现有腾讯文档标签页启用侧边栏
   🔄 侧边栏初始化状态已重置
   ```

3. **测试功能**
   ```
   1. 打开或刷新腾讯文档表格页面
   2. 点击插件图标
   3. 侧边栏应该能正常打开并显示内容
   ```

### ⚡ **自动修复功能**

扩展现在包含智能修复机制：
- 检测到 `No active side panel` 错误时自动重置配置
- 提供详细的修复过程日志
- 建议用户重新点击图标尝试

### 🆘 **如果问题仍然存在**

请提供以下诊断信息：
1. 重新加载扩展后的背景脚本初始化日志
2. 点击图标时的完整错误日志（如果有）
3. Chrome版本信息和操作系统

**经过这次修复，插件应该能稳定正常工作了！**

---

🔄 **本指南会根据用户反馈持续更新，确保涵盖最新的问题和解决方案。**