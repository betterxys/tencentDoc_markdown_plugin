<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•å¢å¼ºçš„æ–‡æœ¬æå–ç­–ç•¥</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 4px solid #007cba; }
        .success { border-left-color: green; background: #f0fff0; }
        .warning { border-left-color: orange; background: #fff8e7; }
        .error { border-left-color: red; background: #fff0f0; }
        button { padding: 8px 16px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a87; }
        pre { background: #f8f8f8; padding: 10px; overflow-x: auto; border: 1px solid #ddd; font-size: 12px; }
        .comparison { display: flex; gap: 20px; }
        .comparison > div { flex: 1; }
        .dom-simulator { border: 2px solid #007cba; padding: 15px; margin: 10px 0; background: #f9f9f9; }
    </style>
</head>
<body>
    <h1>å¢å¼ºæ–‡æœ¬æå–ç­–ç•¥æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æ¨¡æ‹Ÿè…¾è®¯æ–‡æ¡£DOMç»“æ„</h2>
        <p>ä»¥ä¸‹æ˜¯æ¨¡æ‹Ÿçš„è…¾è®¯æ–‡æ¡£DOMç»“æ„ï¼ŒåŒ…å«å¯èƒ½å¯¼è‡´æ–‡æœ¬æ±¡æŸ“çš„å„ç§æƒ…å†µï¼š</p>
        
        <!-- æ¨¡æ‹Ÿå…¬å¼æ  - åŒ…å«input.valueï¼ˆæœ€çº¯å‡€çš„æ•°æ®æºï¼‰ -->
        <div class="dom-simulator">
            <h3>æƒ…å†µ1: å…¬å¼æ å¸¦input.value</h3>
            <div class="formula-bar">
                <div class="formula-input">
                    <input type="text" value="| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** | **ç½‘å®‰é™©ä¿éšœé‡ç‚¹** | **æ”¿ç­–ä¾æ®** |
|----------|------------------|-------------------|-------------|
| **åŒ–å·¥è¡Œä¸š** | å·¥æ§ç³»ç»Ÿé­å‹’ç´¢æ”»å‡» | è¦†ç›–åœäº§æŸå¤± | ã€Šå·¥ä¸šæ§åˆ¶ç³»ç»ŸæŒ‡å—ã€‹ |
| **ç”µåŠ›è¡Œä¸š** | ç”µç½‘ç›‘æ§ç³»ç»Ÿè¢«å…¥ä¾µ | èµ”å¿ç”µç½‘ç˜«ç—ªç½šæ¬¾ | ã€Šç”µåŠ›å¯é æ€§ç®¡ç†åŠæ³•ã€‹ |">
                    <div>| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** | **ç½‘å®‰é™©ä¿éšœé‡ç‚¹** | **æ”¿ç­–ä¾æ®** |</div>
                    <div></div>
                    <div>|----------|------------------|-------------------|-------------|</div>
                    <div></div>
                    <div>| **åŒ–å·¥è¡Œä¸š** | å·¥æ§ç³»ç»Ÿé­å‹’ç´¢æ”»å‡» | è¦†ç›–åœäº§æŸå¤± | ã€Šå·¥ä¸šæ§åˆ¶ç³»ç»ŸæŒ‡å—ã€‹ |</div>
                    <div></div>
                    <div>| **ç”µåŠ›è¡Œä¸š** | ç”µç½‘ç›‘æ§ç³»ç»Ÿè¢«å…¥ä¾µ | èµ”å¿ç”µç½‘ç˜«ç—ªç½šæ¬¾ | ã€Šç”µåŠ›å¯é æ€§ç®¡ç†åŠæ³•ã€‹ |</div>
                </div>
            </div>
        </div>
        
        <!-- æ¨¡æ‹Ÿåªæœ‰DOMç»“æ„ï¼Œæ²¡æœ‰input.value -->
        <div class="dom-simulator">
            <h3>æƒ…å†µ2: åªæœ‰DOMç»“æ„ï¼ˆæœ‰æ±¡æŸ“ï¼‰</h3>
            <div class="ae-formula-input" id="dom-only-container">
                <div>| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** | **ç½‘å®‰é™©ä¿éšœé‡ç‚¹** | **æ”¿ç­–ä¾æ®** |</div>
                <div></div>
                <div>|----------|------------------|-------------------|-------------|</div>
                <div></div>
                <div>| **åŒ–å·¥è¡Œä¸š** | å·¥æ§ç³»ç»Ÿé­å‹’ç´¢æ”»å‡» | è¦†ç›–åœäº§æŸå¤± | ã€Šå·¥ä¸šæ§åˆ¶ç³»ç»ŸæŒ‡å—ã€‹ |</div>
                <div></div>
                <div>| **ç”µåŠ›è¡Œä¸š** | ç”µç½‘ç›‘æ§ç³»ç»Ÿè¢«å…¥ä¾µ | èµ”å¿ç”µç½‘ç˜«ç—ªç½šæ¬¾ | ã€Šç”µåŠ›å¯é æ€§ç®¡ç†åŠæ³•ã€‹ |</div>
            </div>
        </div>
        
        <!-- æ¨¡æ‹ŸåŒ…å«dataå±æ€§çš„æƒ…å†µ -->
        <div class="dom-simulator">
            <h3>æƒ…å†µ3: åŒ…å«data-valueå±æ€§</h3>
            <div class="table-input-stage" 
                 data-value="| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** | **ç½‘å®‰é™©ä¿éšœé‡ç‚¹** | **æ”¿ç­–ä¾æ®** |
|----------|------------------|-------------------|-------------|
| **åŒ–å·¥è¡Œä¸š** | å·¥æ§ç³»ç»Ÿé­å‹’ç´¢æ”»å‡» | è¦†ç›–åœäº§æŸå¤± | ã€Šå·¥ä¸šæ§åˆ¶ç³»ç»ŸæŒ‡å—ã€‹ |
| **ç”µåŠ›è¡Œä¸š** | ç”µç½‘ç›‘æ§ç³»ç»Ÿè¢«å…¥ä¾µ | èµ”å¿ç”µç½‘ç˜«ç—ªç½šæ¬¾ | ã€Šç”µåŠ›å¯é æ€§ç®¡ç†åŠæ³•ã€‹ |">
                <span>DOMæ˜¾ç¤ºçš„å†…å®¹ï¼ˆå¯èƒ½æœ‰æ ¼å¼åŒ–é—®é¢˜ï¼‰</span>
                <br>
                <span>| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** |</span>
                <br><br>
                <span>|----------|------------------|</span>
            </div>
        </div>
        
        <!-- æ¨¡æ‹Ÿå…¨å±€æ•°æ®å¯¹è±¡ -->
        <div class="dom-simulator">
            <h3>æƒ…å†µ4: å…¨å±€æ•°æ®å¯¹è±¡æ¨¡æ‹Ÿ</h3>
            <p>æ¨¡æ‹Ÿwindow.basicClientVarså¯¹è±¡ï¼ˆåœ¨JavaScriptä¸­è®¾ç½®ï¼‰</p>
            <pre id="global-data-display">ç­‰å¾…JavaScriptè®¾ç½®å…¨å±€æ•°æ®...</pre>
        </div>
    </div>
    
    <div class="test-section">
        <h2>æå–ç­–ç•¥æµ‹è¯•</h2>
        <button onclick="testAllStrategies()">æµ‹è¯•æ‰€æœ‰æå–ç­–ç•¥</button>
        <button onclick="compareResults()">å¯¹æ¯”æå–ç»“æœ</button>
        <div id="strategy-results" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>å¯¹æ¯”åˆ†æ</h2>
        <div class="comparison">
            <div>
                <h3>åŸå§‹æ­£ç¡®æ–‡æœ¬</h3>
                <pre id="original-text">| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** | **ç½‘å®‰é™©ä¿éšœé‡ç‚¹** | **æ”¿ç­–ä¾æ®** |
|----------|------------------|-------------------|-------------|
| **åŒ–å·¥è¡Œä¸š** | å·¥æ§ç³»ç»Ÿé­å‹’ç´¢æ”»å‡» | è¦†ç›–åœäº§æŸå¤± | ã€Šå·¥ä¸šæ§åˆ¶ç³»ç»ŸæŒ‡å—ã€‹ |
| **ç”µåŠ›è¡Œä¸š** | ç”µç½‘ç›‘æ§ç³»ç»Ÿè¢«å…¥ä¾µ | èµ”å¿ç”µç½‘ç˜«ç—ªç½šæ¬¾ | ã€Šç”µåŠ›å¯é æ€§ç®¡ç†åŠæ³•ã€‹ |</pre>
            </div>
            <div>
                <h3>æœ€ä½³æå–ç»“æœ</h3>
                <pre id="best-extraction-result">ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹ç»“æœ</pre>
            </div>
        </div>
        <div id="comparison-analysis" class="result"></div>
    </div>
    
    <!-- åŠ è½½å¢å¼ºæå–ç­–ç•¥ -->
    <script src="enhanced_extraction_strategy.js"></script>
    
    <script>
        // æ­£ç¡®çš„åŸå§‹æ–‡æœ¬ï¼ˆåŸºå‡†ï¼‰
        const originalCorrectText = `| **è¡Œä¸š** | **æ ¸å¿ƒé£é™©åœºæ™¯** | **ç½‘å®‰é™©ä¿éšœé‡ç‚¹** | **æ”¿ç­–ä¾æ®** |
|----------|------------------|-------------------|-------------|
| **åŒ–å·¥è¡Œä¸š** | å·¥æ§ç³»ç»Ÿé­å‹’ç´¢æ”»å‡» | è¦†ç›–åœäº§æŸå¤± | ã€Šå·¥ä¸šæ§åˆ¶ç³»ç»ŸæŒ‡å—ã€‹ |
| **ç”µåŠ›è¡Œä¸š** | ç”µç½‘ç›‘æ§ç³»ç»Ÿè¢«å…¥ä¾µ | èµ”å¿ç”µç½‘ç˜«ç—ªç½šæ¬¾ | ã€Šç”µåŠ›å¯é æ€§ç®¡ç†åŠæ³•ã€‹ |`;
        
        // æ¨¡æ‹Ÿè…¾è®¯æ–‡æ¡£çš„å…¨å±€æ•°æ®å¯¹è±¡
        window.basicClientVars = {
            padData: {
                currentCell: {
                    content: originalCorrectText,
                    value: originalCorrectText
                },
                selectedCell: {
                    content: originalCorrectText
                }
            },
            cellData: {
                content: originalCorrectText,
                value: originalCorrectText
            },
            formulaBar: {
                content: originalCorrectText,
                value: originalCorrectText
            }
        };
        
        // æ˜¾ç¤ºå…¨å±€æ•°æ®
        document.getElementById('global-data-display').textContent = 
            JSON.stringify(window.basicClientVars, null, 2);
        
        function testAllStrategies() {
            const results = document.getElementById('strategy-results');
            let html = '<h3>å„æå–ç­–ç•¥æµ‹è¯•ç»“æœ:</h3>';
            
            try {
                // æµ‹è¯•ç­–ç•¥1: æ•°æ®æ¨¡å‹
                console.log('=== æµ‹è¯•ç­–ç•¥1: æ•°æ®æ¨¡å‹ ===');
                const dataModelResult = EnhancedTextExtractor.extractFromDataModel();
                html += `<div><strong>ç­–ç•¥1 - æ•°æ®æ¨¡å‹:</strong> ${dataModelResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</div>`;
                if (dataModelResult) {
                    html += `<pre>${dataModelResult.substring(0, 100)}...</pre>`;
                }
                
                // æµ‹è¯•ç­–ç•¥2: Input Value
                console.log('=== æµ‹è¯•ç­–ç•¥2: Input Value ===');
                const inputValueResult = EnhancedTextExtractor.extractFromInputValue();
                html += `<div><strong>ç­–ç•¥2 - Input Value:</strong> ${inputValueResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</div>`;
                if (inputValueResult) {
                    html += `<pre>${inputValueResult.substring(0, 100)}...</pre>`;
                }
                
                // æµ‹è¯•ç­–ç•¥3: Dataå±æ€§
                console.log('=== æµ‹è¯•ç­–ç•¥3: Dataå±æ€§ ===');
                const dataAttrResult = EnhancedTextExtractor.extractFromDataAttributes();
                html += `<div><strong>ç­–ç•¥3 - Dataå±æ€§:</strong> ${dataAttrResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</div>`;
                if (dataAttrResult) {
                    html += `<pre>${dataAttrResult.substring(0, 100)}...</pre>`;
                }
                
                // æµ‹è¯•ç­–ç•¥4: TextContent
                console.log('=== æµ‹è¯•ç­–ç•¥4: TextContent ===');
                const textContentResult = EnhancedTextExtractor.extractFromTextContent();
                html += `<div><strong>ç­–ç•¥4 - TextContent:</strong> ${textContentResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</div>`;
                if (textContentResult) {
                    html += `<pre>${textContentResult.substring(0, 100)}...</pre>`;
                }
                
                // æµ‹è¯•ç­–ç•¥5: DOMæ¸…ç†
                console.log('=== æµ‹è¯•ç­–ç•¥5: DOMæ¸…ç† ===');
                const domCleanResult = EnhancedTextExtractor.extractFromCleanDOM();
                html += `<div><strong>ç­–ç•¥5 - DOMæ¸…ç†:</strong> ${domCleanResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</div>`;
                if (domCleanResult) {
                    html += `<pre>${domCleanResult.substring(0, 100)}...</pre>`;
                }
                
                // æµ‹è¯•ç»¼åˆç­–ç•¥
                console.log('=== æµ‹è¯•ç»¼åˆç­–ç•¥ ===');
                const enhancedResult = EnhancedTextExtractor.extractPureText();
                html += `<div><strong>âœ¨ ç»¼åˆç­–ç•¥:</strong> ${enhancedResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</div>`;
                if (enhancedResult) {
                    html += `<pre>${enhancedResult.substring(0, 200)}...</pre>`;
                    
                    // å­˜å‚¨æœ€ä½³ç»“æœ
                    document.getElementById('best-extraction-result').textContent = enhancedResult;
                }
                
            } catch (error) {
                html += `<div class="error">æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}</div>`;
            }
            
            results.innerHTML = html;
        }
        
        function compareResults() {
            const analysisDiv = document.getElementById('comparison-analysis');
            const bestResult = document.getElementById('best-extraction-result').textContent;
            
            if (bestResult === 'ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹ç»“æœ') {
                analysisDiv.innerHTML = '<div class="warning">è¯·å…ˆè¿è¡Œæå–ç­–ç•¥æµ‹è¯•</div>';
                return;
            }
            
            // æ¯”è¾ƒæ–‡æœ¬
            const isExactMatch = bestResult.trim() === originalCorrectText.trim();
            const hasExtraNewlines = /\|\n\s*\n\|/.test(bestResult);
            const lengthDiff = bestResult.length - originalCorrectText.length;
            
            let analysis = '<h3>æ–‡æœ¬ä¸€è‡´æ€§åˆ†æ:</h3>';
            analysis += `<div><strong>å®Œå…¨åŒ¹é…:</strong> ${isExactMatch ? 'âœ… æ˜¯' : 'âŒ å¦'}</div>`;
            analysis += `<div><strong>åŒ…å«å¤šä½™ç©ºè¡Œ:</strong> ${hasExtraNewlines ? 'âŒ æ˜¯' : 'âœ… å¦'}</div>`;
            analysis += `<div><strong>é•¿åº¦å·®å¼‚:</strong> ${lengthDiff} ä¸ªå­—ç¬¦</div>`;
            
            if (isExactMatch) {
                analysis += '<div class="success"><strong>ğŸ‰ å®Œç¾ï¼</strong> æå–çš„æ–‡æœ¬ä¸åŸå§‹æ–‡æœ¬å®Œå…¨ä¸€è‡´ï¼Œäº‹å‰æå–ç­–ç•¥æˆåŠŸï¼</div>';
            } else {
                analysis += '<div class="warning"><strong>âš ï¸ ä»æœ‰å·®å¼‚</strong> éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–æå–ç­–ç•¥</div>';
                
                // è¯¦ç»†å·®å¼‚åˆ†æ
                analysis += '<h4>è¯¦ç»†å·®å¼‚:</h4>';
                const originalLines = originalCorrectText.split('\n');
                const extractedLines = bestResult.split('\n');
                
                analysis += `<div>åŸå§‹è¡Œæ•°: ${originalLines.length}, æå–è¡Œæ•°: ${extractedLines.length}</div>`;
                
                // æ˜¾ç¤ºå‰å‡ è¡Œçš„å¯¹æ¯”
                for (let i = 0; i < Math.max(originalLines.length, extractedLines.length) && i < 5; i++) {
                    const orig = originalLines[i] || '(ç©ºè¡Œ)';
                    const extr = extractedLines[i] || '(ç©ºè¡Œ)';
                    const matches = orig === extr;
                    
                    analysis += `<div>è¡Œ${i+1}: ${matches ? 'âœ…' : 'âŒ'} ${matches ? 'åŒ¹é…' : 'ä¸åŒ¹é…'}</div>`;
                    if (!matches) {
                        analysis += `<div style="margin-left: 20px;">åŸå§‹: "${orig}"</div>`;
                        analysis += `<div style="margin-left: 20px;">æå–: "${extr}"</div>`;
                    }
                }
            }
            
            analysisDiv.innerHTML = analysis;
            analysisDiv.className = isExactMatch ? 'result success' : 'result warning';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', function() {
            setTimeout(() => {
                testAllStrategies();
                setTimeout(() => {
                    compareResults();
                }, 1000);
            }, 500);
        });
    </script>
</body>
</html>