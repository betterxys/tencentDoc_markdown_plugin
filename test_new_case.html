<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ–°æµ‹è¯•ç”¨ä¾‹ - è¡Œä¸šä¸“å±é™„åŠ é™©è¡¨æ ¼</title>
    <script src="lib/marked.min.js"></script>
    <script src="lib/purify.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .test-header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 30px 0;
            border: 2px solid #007bff;
            padding: 25px;
            border-radius: 10px;
            background-color: #f8f9fa;
        }
        
        .result-container {
            border: 2px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background-color: white;
            min-height: 200px;
        }
        
        .debug-section {
            background: #343a40;
            color: #00ff41;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        /* å¢å¼ºçš„è¡¨æ ¼æ ·å¼ */
        table {
            border-collapse: collapse !important;
            width: 100% !important;
            margin: 20px 0 !important;
            border: 2px solid #2196f3 !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        th {
            padding: 15px !important;
            text-align: left !important;
            background: linear-gradient(135deg, #2196f3, #1976d2) !important;
            color: white !important;
            font-weight: 600 !important;
            border: 1px solid #1976d2 !important;
        }
        
        td {
            padding: 12px 15px !important;
            border: 1px solid #e0e0e0 !important;
            background-color: #ffffff !important;
            vertical-align: top !important;
        }
        
        tr:nth-child(even) td {
            background-color: #f5f5f5 !important;
        }
        
        tr:hover td {
            background-color: #e3f2fd !important;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-header">
            <h1>ğŸ§ª æ–°æµ‹è¯•ç”¨ä¾‹éªŒè¯</h1>
            <p>è¡Œä¸šä¸“å±é™„åŠ é™©è¡¨æ ¼æ¸²æŸ“æµ‹è¯•</p>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•å†…å®¹</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="runTest()">ğŸš€ æµ‹è¯•é¢„è®¾å†…å®¹</button>
                <button class="btn" onclick="runCustomTest()" style="margin-left: 10px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">âœï¸ æµ‹è¯•è‡ªå®šä¹‰å†…å®¹</button>
            </div>
            
            <div id="custom-input-section" style="display: none; margin-bottom: 20px; padding: 20px; border: 2px dashed #28a745; border-radius: 8px; background-color: #f8fff4;">
                <h3 style="margin-top: 0; color: #28a745;">âœï¸ è¾“å…¥è‡ªå®šä¹‰æµ‹è¯•å†…å®¹</h3>
                <textarea id="custom-content" placeholder="åœ¨è¿™é‡Œç²˜è´´æ‚¨è¦æµ‹è¯•çš„Markdownå†…å®¹..." style="width: 100%; height: 200px; padding: 15px; border: 1px solid #ccc; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; resize: vertical;"></textarea>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="testCustomContent()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ğŸ§ª æ‰§è¡Œè‡ªå®šä¹‰æµ‹è¯•</button>
                    <button onclick="toggleCustomInput()" style="margin-left: 10px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">âŒ å…³é—­</button>
                </div>
            </div>
            
            <div class="stats-grid" id="stats-grid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="stat-detection">-</div>
                    <div class="stat-label">è¡¨æ ¼æ£€æµ‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-tables">-</div>
                    <div class="stat-label">è¡¨æ ¼æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-rows">-</div>
                    <div class="stat-label">è¡¨æ ¼è¡Œæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-cells">-</div>
                    <div class="stat-label">è¡¨æ ¼å•å…ƒæ ¼</div>
                </div>
            </div>
            
            <div class="result-container" id="result-container">
                <p style="text-align: center; color: #666;">ç‚¹å‡»"æ‰§è¡Œæµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•</p>
            </div>
            
            <details>
                <summary style="cursor: pointer; font-weight: bold; color: #1976d2;">ğŸ“Š æŸ¥çœ‹è¯¦ç»†è°ƒè¯•ä¿¡æ¯</summary>
                <div class="debug-section" id="debug-log"></div>
            </details>
        </div>
    </div>
    
    <script>
        function log(message, level = 'info') {
            const debugDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const icons = {
                'success': 'âœ…',
                'error': 'âŒ', 
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            };
            const icon = icons[level] || 'â„¹ï¸';
            debugDiv.textContent += `[${timestamp}] ${icon} ${message}\n`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }
        
        function updateStats(detection, tablesCount, rowsCount, cellsCount) {
            document.getElementById('stat-detection').textContent = detection ? 'âœ…' : 'âŒ';
            document.getElementById('stat-detection').className = detection ? 'stat-value success' : 'stat-value error';
            
            document.getElementById('stat-tables').textContent = tablesCount;
            document.getElementById('stat-rows').textContent = rowsCount;
            document.getElementById('stat-cells').textContent = cellsCount;
            
            document.getElementById('stats-grid').style.display = 'grid';
        }
        
        function toggleCustomInput() {
            const section = document.getElementById('custom-input-section');
            if (section.style.display === 'none') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }
        
        function runCustomTest() {
            toggleCustomInput();
        }
        
        function testCustomContent() {
            const customContent = document.getElementById('custom-content').value.trim();
            if (!customContent) {
                alert('è¯·å…ˆè¾“å…¥è¦æµ‹è¯•çš„å†…å®¹ï¼');
                return;
            }
            
            clearLog();
            log('ğŸš€ å¼€å§‹æµ‹è¯•è‡ªå®šä¹‰å†…å®¹');
            executeTest(customContent);
        }
        
        function runTest() {
            clearLog();
            log('ğŸš€ å¼€å§‹æµ‹è¯•é¢„è®¾å†…å®¹ï¼šè¡Œä¸šä¸“å±é™„åŠ é™©è¡¨æ ¼');
            
            const testContent = \`#### **2. è¡Œä¸šä¸“å±é™„åŠ é™©**

| **è¡Œä¸š**   | **é™„åŠ é™©ç§**                | **è§¦å‘æ¡ä»¶**                          | **æ¡ˆä¾‹å‚è€ƒ** |

|------------|----------------------------|---------------------------------------|-------------|

| **åŒ–å·¥**    | å·¥è‰ºå‚æ•°ç¯¡æ”¹è´£ä»»é™©          | å› æœºå™¨äººä¼ è¾“æ•°æ®è¢«ç¯¡æ”¹å¼•å‘ç”Ÿäº§äº‹æ•…      | æŸç‚¼æ²¹å‚å› æ§åˆ¶ç³»ç»Ÿé­å…¥ä¾µè‡´æ³„æ¼ï¼Œèµ”ä»˜1200ä¸‡[citation:8] |

| **ç”µåŠ›**    | æ–°èƒ½æºåœºç«™è„±ç½‘æŸå¤±é™©        | é£ç”µåœº/å…‰ä¼ç”µç«™å› æ”»å‡»è„±ç½‘å¯¼è‡´çš„å‘ç”µè¡¥å¿ | å±±ä¸œå…±ä¿ä½“è¦†ç›–å…‰ä¼ç”µç«™åœæœºæŸå¤±[citation:3] |\`;
            
            executeTest(testContent);
        }
        
        function executeTest(testContent) {
            log(\`æµ‹è¯•å†…å®¹é•¿åº¦: \${testContent.length} å­—ç¬¦\`);
            
            // 1. è¡¨æ ¼æ£€æµ‹æµ‹è¯•
            log('\\nğŸ“‹ æ­¥éª¤1: è¡¨æ ¼æ£€æµ‹åˆ†æ');
            const hasTableNew = /\|.*\|[\s\S]*?\n\s*\|(\s*[\-:]+\s*\|)+\s*/.test(testContent);
            const hasTableOld = /\|.*\|/.test(testContent);
            
            log(\`æ–°æ£€æµ‹é€»è¾‘: \${hasTableNew}\`, hasTableNew ? 'success' : 'error');
            log(\`æ—§æ£€æµ‹é€»è¾‘: \${hasTableOld}\`, hasTableOld ? 'success' : 'error');
            
            // 2. è¡¨æ ¼ç»“æ„åˆ†æ
            log('\\nğŸ” æ­¥éª¤2: è¡¨æ ¼ç»“æ„åˆ†æ');
            const lines = testContent.split('\\n');
            const tableLines = lines.filter(line => line.trim().includes('|'));
            log(\`æ€»å…± \${tableLines.length} è¡ŒåŒ…å«è¡¨æ ¼æ ‡è®°\`);
            
            tableLines.forEach((line, i) => {
                const cells = line.split('|').filter(cell => cell.trim());
                log(\`  è¡Œ\${i+1}: \${cells.length}åˆ— - \${line.substring(0, 50)}...\`);
            });
            
            // 3. ç©ºè¡Œåˆ†æ
            log('\\nğŸ“ æ­¥éª¤3: ç©ºè¡Œåˆ†æ');
            const emptyLines = [];
            lines.forEach((line, i) => {
                if (line.trim() === '') {
                    emptyLines.push(i + 1);
                }
            });
            log(\`å‘ç° \${emptyLines.length} ä¸ªç©ºè¡Œï¼Œä½ç½®: [\${emptyLines.join(', ')}]\`);
            
            // 4. Markdownæ¸²æŸ“æµ‹è¯•
            log('\\nğŸ¨ æ­¥éª¤4: Markdownæ¸²æŸ“æµ‹è¯•');
            try {
                let html;
                if (typeof marked.parse === 'function') {
                    html = marked.parse(testContent, { 
                        gfm: true, 
                        breaks: false,
                        pedantic: false 
                    });
                    log('ä½¿ç”¨ marked.parse() æˆåŠŸ', 'success');
                } else {
                    html = marked(testContent, { 
                        gfm: true, 
                        breaks: false,
                        pedantic: false 
                    });
                    log('ä½¿ç”¨ marked() æˆåŠŸ', 'success');
                }
                
                log(\`ç”ŸæˆHTMLé•¿åº¦: \${html.length} å­—ç¬¦\`);
                log(\`åŒ…å«<table>æ ‡ç­¾: \${/<table/.test(html)}\`, /<table/.test(html) ? 'success' : 'error');
                log(\`åŒ…å«<th>æ ‡ç­¾: \${/<th/.test(html)}\`, /<th/.test(html) ? 'success' : 'error');
                log(\`åŒ…å«<td>æ ‡ç­¾: \${/<td/.test(html)}\`, /<td/.test(html) ? 'success' : 'error');
                
                // 5. DOMPurifyæ¸…ç†
                log('\\nğŸ§¹ æ­¥éª¤5: DOMPurify HTMLæ¸…ç†');
                const cleanHtml = DOMPurify.sanitize(html, {
                    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'div', 'span', 'strong', 'em', 'u', 'code', 'pre', 'ul', 'ol', 'li', 'blockquote', 'a', 'img', 'br', 'hr', 'table', 'thead', 'tbody', 'tr', 'th', 'td'],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'align', 'style', 'colspan', 'rowspan']
                });
                
                log(\`æ¸…ç†åHTMLé•¿åº¦: \${cleanHtml.length} å­—ç¬¦\`);
                log(\`æœ€ç»ˆåŒ…å«<table>æ ‡ç­¾: \${/<table/.test(cleanHtml)}\`, /<table/.test(cleanHtml) ? 'success' : 'error');
                
                // 6. æ¸²æŸ“åˆ°é¡µé¢
                log('\\nğŸ–¼ï¸ æ­¥éª¤6: é¡µé¢æ¸²æŸ“');
                document.getElementById('result-container').innerHTML = cleanHtml;
                
                // 7. éªŒè¯æ¸²æŸ“ç»“æœ
                log('\\nâœ… æ­¥éª¤7: ç»“æœéªŒè¯');
                const tables = document.getElementById('result-container').querySelectorAll('table');
                const totalRows = document.getElementById('result-container').querySelectorAll('tr');
                const totalCells = document.getElementById('result-container').querySelectorAll('th, td');
                
                log(\`å®é™…æ¸²æŸ“çš„è¡¨æ ¼æ•°é‡: \${tables.length}\`, tables.length > 0 ? 'success' : 'error');
                log(\`æ€»è¡Œæ•°: \${totalRows.length}\`);
                log(\`æ€»å•å…ƒæ ¼æ•°: \${totalCells.length}\`);
                
                if (tables.length > 0) {
                    tables.forEach((table, i) => {
                        const headers = table.querySelectorAll('th');
                        const cells = table.querySelectorAll('td');
                        const rows = table.querySelectorAll('tr');
                        log(\`è¡¨æ ¼\${i+1}: \${rows.length}è¡Œ, \${headers.length}ä¸ªè¡¨å¤´, \${cells.length}ä¸ªæ•°æ®å•å…ƒæ ¼\`, 'success');
                    });
                }
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateStats(hasTableNew, tables.length, totalRows.length, totalCells.length);
                
                if (tables.length > 0) {
                    log('\\nğŸ‰ æµ‹è¯•æˆåŠŸï¼è¡¨æ ¼å·²æ­£ç¡®æ¸²æŸ“', 'success');
                } else {
                    log('\\nâŒ æµ‹è¯•å¤±è´¥ï¼è¡¨æ ¼æœªèƒ½æ¸²æŸ“', 'error');
                }
                
            } catch (error) {
                log(\`æ¸²æŸ“é”™è¯¯: \${error.message}\`, 'error');
                document.getElementById('result-container').innerHTML = 
                    \`<div style="color: red; font-weight: bold; text-align: center; padding: 40px;">
                        âŒ æ¸²æŸ“å¤±è´¥: \${error.message}
                    </div>\`;
            }
            
            log('\\nğŸ“ æµ‹è¯•å®Œæˆ');
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        window.onload = function() {
            console.log('ğŸ”§ æ–°æµ‹è¯•ç”¨ä¾‹é¡µé¢å·²åŠ è½½');
            console.log('System Info:');
            console.log('- marked.jsç‰ˆæœ¬:', marked.version || 'unknown');
            console.log('- DOMPurifyå¯ç”¨:', typeof DOMPurify === 'object');
            console.log('- æµè§ˆå™¨:', navigator.userAgent);
        };
    </script>
</body>
</html>